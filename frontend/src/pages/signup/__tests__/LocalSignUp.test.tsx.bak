/** @vitest-environment jsdom */ import { describe, test, expect, beforeEach, afterEach, vi } from 'vitest'; vi.mock('@/config/featureFlags', () => ({ emailConfirmationEnabled: false })); vi.mock('@/lib/api', () => ({   createUser: vi.fn(),   confirmEmail: vi.fn(),   isEmailAvailable: vi.fn().mockResolvedValue(true),   isNicknameAvailable: vi.fn().mockResolvedValue(true), }));import React from 'react'; import { render, screen, fireEvent, waitFor, cleanup } from '@testing-library/react'; import '@testing-library/jest-dom/vitest'; import LocalSignUp from '../LocalSignUp'; import * as api from '@/lib/api'; import { TranslationProvider } from '@/hooks/useTranslation'; import { useTranslation } from '@/hooks/useTranslation';// Helper: diacritic-insensitive matcher for Testing Libraryconst strip = (s: string) => s.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();const containsNormalized = (expected: string) => (actual: string) => strip(actual).includes(strip(expected)); describe('LocalSignUp', () => {   beforeEach(() => {     vi.clearAllMocks();   });   afterEach(() => {     cleanup();   });     const renderComponent = () =>     render(       <TranslationProvider>         <LocalSignUp />       </TranslationProvider>     );     const renderWithLanguage = (lang: 'en'|'es'|'fr') => {     const LangSetter = () => {       const { setLanguage } = useTranslation();        React.useEffect(() => { setLanguage(lang); }, [lang]);       return null;     };       return render(       <TranslationProvider>         <LangSetter />         <LocalSignUp />       </TranslationProvider>     );   };      test('renders form fields', () => {     renderComponent();     expect(screen.getByLabelText(/email address/i)).toBeInTheDocument();         expect(screen.getByLabelText(/full name/i)).toBeInTheDocument();     expect(screen.getByLabelText(/^password$/i)).toBeInTheDocument();         expect(screen.getByLabelText(/confirm password/i)).toBeInTheDocument();   });        test('shows validation errors on empty submit', async () => {           renderComponent();           fireEvent.click(screen.getByRole('button', { name: /create account/i }));           const errs = await screen.findAllByText(/this field is required/i);                expect(errs.length).toBeGreaterThanOrEqual(4);                 });          test('shows password mismatch error', async () => {             renderComponent();             fireEvent.change(screen.getByLabelText(/^password$/i), { target: { value: 'password1' } });        fireEvent.change(screen.getByLabelText(/confirm password/i), { target: { value: 'password2' } });             fireEvent.click(screen.getByRole('button', { name: /create account/i }));             expect(await screen.findByText(/passwords do not match/i)).toBeInTheDocument();   });        test('submits form successfully', async () => {               (api.createUser as unknown as ReturnType<typeof vi.fn>).mockResolvedValue({});          (api.confirmEmail as unknown as ReturnType<typeof vi.fn>).mockResolvedValue(undefined);                renderComponent();          fireEvent.change(screen.getByLabelText(/email address/i), { target: { value: 'test@example.com' } });          fireEvent.change(screen.getByLabelText(/full name/i), { target: { value: 'Test User' } });               fireEvent.change(screen.getByLabelText(/nickname/i), { target: { value: 'nick' } });               fireEvent.change(screen.getByLabelText(/date of birth/i), { target: { value: '2000-01-01' } });               const countryInput = screen.getByLabelText(/country/i);     fireEvent.change(countryInput, { target: { value: 'United States' } });               // pick first matching option               const opt = await screen.findByRole('button', { name: /United States/i });               fireEvent.click(opt);               fireEvent.change(screen.getByLabelText(/^password$/i), { target: { value: 'Aa1!aaaa' } });               fireEvent.change(screen.getByLabelText(/confirm password/i), { target: { value: 'Aa1!aaaa' } });                fireEvent.click(screen.getByRole('button', { name: /create account/i }));                await waitFor(() => {                   expect(api.createUser).toHaveBeenCalledWith(expect.objectContaining({         email: 'test@example.com',         fullName: 'Test User',         password: 'Aa1!aaaa',         status: 'active',       }));                         expect(screen.getByText(/Account created!/i)).toBeInTheDocument();     });             });          test('shows error message on submission failure', async () => {                   (api.createUser as unknown as ReturnType<typeof vi.fn>).mockRejectedValue(new Error('Failed'));                   renderComponent();      fireEvent.change(screen.getByLabelText(/email address/i), { target: { value: 'fail@example.com' } });                   fireEvent.change(screen.getByLabelText(/full name/i), { target: { value: 'Fail User' } });                        fireEvent.change(screen.getByLabelText(/nickname/i), { target: { value: 'nick' } });                        fireEvent.change(screen.getByLabelText(/date of birth/i), { target: { value: '2000-01-01' } });                        const ctry = screen.getByLabelText(/country/i);     fireEvent.change(ctry, { target: { value: 'United States' } });                        const pick = await screen.findByRole('button', { name: /United States/i });     fireEvent.click(pick);                        fireEvent.change(screen.getByLabelText(/^password$/i), { target: { value: 'Aa1!aaaa' } });                        fireEvent.change(screen.getByLabelText(/confirm password/i), { target: { value: 'Aa1!aaaa' } });                         fireEvent.click(screen.getByRole('button', { name: /create account/i }));                         await waitFor(() => {       expect(screen.getByText(/failed to create account/i)).toBeInTheDocument();     });                     });          test('pronouns select shows placeholder and remains optional if never selected', async () => {                 (api.createUser as unknown as ReturnType<typeof vi.fn>).mockResolvedValue({});                      (api.confirmEmail as unknown as ReturnType<typeof vi.fn>).mockResolvedValue(undefined);                       renderComponent();                       // Placeholder option exists                      expect(await screen.findByRole('option', { name: /select pronouns/i })).toBeInTheDocument();                       // Fill required fields only; leave pronouns/gender blank                      fireEvent.change(screen.getByLabelText(/email address/i), { target: { value: 'popt@example.com' } });                      fireEvent.change(screen.getByLabelText(/full name/i), { target: { value: 'Pop T' } });                      fireEvent.change(screen.getByLabelText(/nickname/i), { target: { value: 'popt' } });                      fireEvent.change(screen.getByLabelText(/date of birth/i), { target: { value: '2000-01-01' } });                      const countryInput = screen.getByLabelText(/country/i);                      fireEvent.change(countryInput, { target: { value: 'United States' } });                      const pick = await screen.findByRole('button', { name: /United States/i });                      fireEvent.click(pick);     fireEvent.change(screen.getByLabelText(/^password$/i), { target: { value: 'Aa1!aaaa' } });                      fireEvent.change(screen.getByLabelText(/confirm password/i), { target: { value: 'Aa1!aaaa' } });                       fireEvent.click(screen.getByRole('button', { name: /create account/i }));                       await waitFor(() => {                               // Should submit successfully without pronouns/gender chosen                               expect(api.createUser).toHaveBeenCalled();                               expect(screen.getByText(/account created/i)).toBeInTheDocument();     });                         });                test('pronouns: selecting then clearing triggers required error on submit', async () => {                   renderComponent();      // Fill required fields                  fireEvent.change(screen.getByLabelText(/email address/i), { target: { value: 'pr@example.com' } });                   fireEvent.change(screen.getByLabelText(/full name/i), { target: { value: 'Pr User' } });                   fireEvent.change(screen.getByLabelText(/nickname/i), { target: { value: 'pru' } });                   fireEvent.change(screen.getByLabelText(/date of birth/i), { target: { value: '2000-01-01' } });                   const ctry = screen.getByLabelText(/country/i);     fireEvent.change(ctry, { target: { value: 'United States' } });                   const pick = await screen.findByRole('button', { name: /United States/i });                   fireEvent.click(pick);                              fireEvent.change(screen.getByLabelText(/^password$/i), { target: { value: 'Aa1!aaaa' } });                   fireEvent.change(screen.getByLabelText(/confirm password/i), { target: { value: 'Aa1!aaaa' } });                    // Select a pronouns value then clear to empty                  const pronounsSelect = screen.getByLabelText(/pronouns/i) as HTMLSelectElement;                   fireEvent.change(pronounsSelect, { target: { value: 'he/him' } });                   expect(pronounsSelect.value).toBe('he/him');                   fireEvent.change(pronounsSelect, { target: { value: '' } });                   expect(pronounsSelect.value).toBe('');                    fireEvent.click(screen.getByRole('button', { name: /create account/i }));                    expect(await screen.findByText(/this field is required/i)).toBeInTheDocument();               });                test('gender: selecting then clearing triggers required error on submit', async () => {                   renderComponent();                    // Fill required fields                   fireEvent.change(screen.getByLabelText(/email address/i), { target: { value: 'ge@example.com' } });                   fireEvent.change(screen.getByLabelText(/full name/i), { target: { value: 'Ge User' } });                   fireEvent.change(screen.getByLabelText(/nickname/i), { target: { value: 'geu' } });                   fireEvent.change(screen.getByLabelText(/date of birth/i), { target: { value: '2000-01-01' } });                   const ctry = screen.getByLabelText(/country/i);     fireEvent.change(ctry, { target: { value: 'United States' } });                   const pick = await screen.findByRole('button', { name: /United States/i });     fireEvent.click(pick);                   fireEvent.change(screen.getByLabelText(/^password$/i), { target: { value: 'Aa1!aaaa' } });                   fireEvent.change(screen.getByLabelText(/confirm password/i), { target: { value: 'Aa1!aaaa' } });                    // Select a gender value then clear to empty                   const genderSelect = screen.getByLabelText(/gender/i) as HTMLSelectElement;                   fireEvent.change(genderSelect, { target: { value: 'male' } });                   expect(genderSelect.value).toBe('male');                   fireEvent.change(genderSelect, { target: { value: '' } });     expect(genderSelect.value).toBe('');                    fireEvent.click(screen.getByRole('button', { name: /create account/i }));                    expect(await screen.findByText(/this field is required/i)).toBeInTheDocument();                 });                test('pronouns placeholder is localized to Spanish', async () => {                     renderWithLanguage('es');                     expect(await screen.findByRole('option', { name: containsNormalized('Selecciona tus pronombres') })).toBeInTheDocument();                 });                 test('pronouns placeholder is localized to French', async () => {                     renderWithLanguage('fr');                     expect(await screen.findByRole('option', { name: /sélectionnez vos pronoms/i })).toBeInTheDocument();   });                    test('country placeholder is localized to Spanish', async () => {     renderWithLanguage('es');                       const countryInput = await screen.findByPlaceholderText(/selecciona tu país/i);                       expect(countryInput).toBeInTheDocument();   });                  test('country placeholder is localized to French', async () => {     renderWithLanguage('fr');                         const countryInput = await screen.findByPlaceholderText(/sélectionnez votre pays/i);                          expect(countryInput).toBeInTheDocument();                   });              test('default pronouns placeholder is English', async () => {                     renderComponent();                     expect(await screen.findByRole('option', { name: /select pronouns/i })).toBeInTheDocument();                 });                test('default country placeholder is English', async () => {     renderComponent();                     const countryInput = await screen.findByPlaceholderText(/select your country/i);                     expect(countryInput).toBeInTheDocument();   });             });/** @vitest-environment jsdom */import React from 'react';import { describe, test, expect, beforeEach, afterEach, vi } from 'vitest';vi.mock('@/lib/api', () => ({  createUser: vi.fn(),  confirmEmail: vi.fn(),  isEmailAvailable: vi.fn().mockResolvedValue(true),  isNicknameAvailable: vi.fn().mockResolvedValue(true),}));import { render, screen, fireEvent, waitFor, cleanup } from '@testing-library/react';import '@testing-library/jest-dom/vitest';import LocalSignUp from '../LocalSignUp';import * as api from '@/lib/api';import { TranslationProvider, useTranslation } from '@/hooks/useTranslation';// Helper: diacritic-insensitive matcher for Testing Librarydescribe('LocalSignUp', () => {  beforeEach(() => {    vi.clearAllMocks();  });  afterEach(() => {    cleanup();  });  const renderComponent = () =>    render(      <TranslationProvider>        <LocalSignUp />      </TranslationProvider>    );  const renderWithLanguage = (lang: 'en'|'es'|'fr') => {    const LangSetter = () => {      const { setLanguage } = useTranslation();      React.useEffect(() => { setLanguage(lang); }, [lang]);      return null;    };    return render(      <TranslationProvider>        <LangSetter />        <LocalSignUp />      </TranslationProvider>    );  };  test('renders form fields', () => {    renderComponent();    expect(screen.getByLabelText(/email address/i)).toBeInTheDocument();    expect(screen.getByLabelText(/full name/i)).toBeInTheDocument();    expect(screen.getByLabelText(/^password$/i)).toBeInTheDocument();    expect(screen.getByLabelText(/confirm password/i)).toBeInTheDocument();  });  test('shows validation errors on empty submit', async () => {    renderComponent();    fireEvent.click(screen.getByRole('button', { name: /create account/i }));    const errs = await screen.findAllByText(/this field is required/i);    expect(errs.length).toBeGreaterThanOrEqual(4);  });  test('shows password mismatch error', async () => {    renderComponent();    fireEvent.change(screen.getByLabelText(/^password$/i), { target: { value: 'password1' } });    fireEvent.change(screen.getByLabelText(/confirm password/i), { target: { value: 'password2' } });    fireEvent.click(screen.getByRole('button', { name: /create account/i }));    expect(await screen.findByText(/passwords do not match/i)).toBeInTheDocument();  });  test('submits form successfully', async () => {    (api.createUser as unknown as ReturnType<typeof vi.fn>).mockResolvedValue({});    (api.confirmEmail as unknown as ReturnType<typeof vi.fn>).mockResolvedValue(undefined);    renderComponent();    fireEvent.change(screen.getByLabelText(/email address/i), { target: { value: 'test@example.com' } });    fireEvent.change(screen.getByLabelText(/full name/i), { target: { value: 'Test User' } });    fireEvent.change(screen.getByLabelText(/nickname/i), { target: { value: 'nick' } });    fireEvent.change(screen.getByLabelText(/date of birth/i), { target: { value: '2000-01-01' } });    const countryInput = screen.getByLabelText(/country/i);    fireEvent.change(countryInput, { target: { value: 'United States' } });    const opt = await screen.findByRole('button', { name: /United States/i });    fireEvent.click(opt);    fireEvent.change(screen.getByLabelText(/^password$/i), { target: { value: 'Aa1!aaaa' } });    fireEvent.change(screen.getByLabelText(/confirm password/i), { target: { value: 'Aa1!aaaa' } });    fireEvent.click(screen.getByRole('button', { name: /create account/i }));    await waitFor(() => {      expect(api.createUser).toHaveBeenCalledWith(expect.objectContaining({        email: 'test@example.com',        fullName: 'Test User',        password: 'Aa1!aaaa',        status: 'active',      }));           expect(screen.getByText(/Account created!/i)).toBeInTheDocument();    });  });  test('shows error message on submission failure', async () => {    (api.createUser as unknown as ReturnType<typeof vi.fn>).mockRejectedValue(new Error('Failed'));    renderComponent();    fireEvent.change(screen.getByLabelText(/email address/i), { target: { value: 'fail@example.com' } });    fireEvent.change(screen.getByLabelText(/full name/i), { target: { value: 'Fail User' } });    fireEvent.change(screen.getByLabelText(/nickname/i), { target: { value: 'nick' } });    fireEvent.change(screen.getByLabelText(/date of birth/i), { target: { value: '2000-01-01' } });    const ctry = screen.getByLabelText(/country/i);    fireEvent.change(ctry, { target: { value: 'United States' } });    const pick = await screen.findByRole('button', { name: /United States/i });    fireEvent.click(pick);    fireEvent.change(screen.getByLabelText(/^password$/i), { target: { value: 'Aa1!aaaa' } });    fireEvent.change(screen.getByLabelText(/confirm password/i), { target: { value: 'Aa1!aaaa' } });    fireEvent.click(screen.getByRole('button', { name: /create account/i }));    await waitFor(() => {      expect(screen.getByText(/failed to create account/i)).toBeInTheDocument();    });  });  test('submits without pronouns/gender when left blank', async () => {    (api.createUser as unknown as ReturnType<typeof vi.fn>).mockResolvedValue({});    (api.confirmEmail as unknown as ReturnType<typeof vi.fn>).mockResolvedValue(undefined);    renderComponent();    fireEvent.change(screen.getByLabelText(/email address/i), { target: { value: 'popt@example.com' } });    fireEvent.change(screen.getByLabelText(/full name/i), { target: { value: 'Pop T' } });    fireEvent.change(screen.getByLabelText(/nickname/i), { target: { value: 'popt' } });    fireEvent.change(screen.getByLabelText(/date of birth/i), { target: { value: '2000-01-01' } });    const countryInput = screen.getByLabelText(/country/i);    fireEvent.change(countryInput, { target: { value: 'United States' } });    const pick = await screen.findByRole('button', { name: /United States/i });    fireEvent.click(pick);    fireEvent.change(screen.getByLabelText(/^password$/i), { target: { value: 'Aa1!aaaa' } });    fireEvent.change(screen.getByLabelText(/confirm password/i), { target: { value: 'Aa1!aaaa' } });    fireEvent.click(screen.getByRole('button', { name: /create account/i }));    await waitFor(() => {      expect(api.createUser).toHaveBeenCalled();      expect(screen.getByText(/account created/i)).toBeInTheDocument();    });  });  test('pronouns: selecting then clearing triggers required error on submit', async () => {    renderComponent();    fireEvent.change(screen.getByLabelText(/email address/i), { target: { value: 'pr@example.com' } });    fireEvent.change(screen.getByLabelText(/full name/i), { target: { value: 'Pr User' } });    fireEvent.change(screen.getByLabelText(/nickname/i), { target: { value: 'pru' } });    fireEvent.change(screen.getByLabelText(/date of birth/i), { target: { value: '2000-01-01' } });    const ctry = screen.getByLabelText(/country/i);    fireEvent.change(ctry, { target: { value: 'United States' } });    const pick = await screen.findByRole('button', { name: /United States/i });    fireEvent.click(pick);    fireEvent.change(screen.getByLabelText(/^password$/i), { target: { value: 'Aa1!aaaa' } });    fireEvent.change(screen.getByLabelText(/confirm password/i), { target: { value: 'Aa1!aaaa' } });    const pronounsSelect = screen.getByLabelText(/pronouns/i) as HTMLSelectElement;    fireEvent.change(pronounsSelect, { target: { value: 'he/him' } });    expect(pronounsSelect.value).toBe('he/him');    fireEvent.change(pronounsSelect, { target: { value: '' } });    expect(pronounsSelect.value).toBe('');    fireEvent.click(screen.getByRole('button', { name: /create account/i }));    expect(await screen.findByText(/this field is required/i)).toBeInTheDocument();  });  test('gender: selecting then clearing triggers required error on submit', async () => {    renderComponent();    fireEvent.change(screen.getByLabelText(/email address/i), { target: { value: 'ge@example.com' } });    fireEvent.change(screen.getByLabelText(/full name/i), { target: { value: 'Ge User' } });    fireEvent.change(screen.getByLabelText(/nickname/i), { target: { value: 'geu' } });    fireEvent.change(screen.getByLabelText(/date of birth/i), { target: { value: '2000-01-01' } });    const ctry = screen.getByLabelText(/country/i);    fireEvent.change(ctry, { target: { value: 'United States' } });    const pick = await screen.findByRole('button', { name: /United States/i });    fireEvent.click(pick);    fireEvent.change(screen.getByLabelText(/^password$/i), { target: { value: 'Aa1!aaaa' } });    fireEvent.change(screen.getByLabelText(/confirm password/i), { target: { value: 'Aa1!aaaa' } });    const genderSelect = screen.getByLabelText(/gender/i) as HTMLSelectElement;    fireEvent.change(genderSelect, { target: { value: 'male' } });    expect(genderSelect.value).toBe('male');    fireEvent.change(genderSelect, { target: { value: '' } });    expect(genderSelect.value).toBe('');    fireEvent.click(screen.getByRole('button', { name: /create account/i }));    expect(await screen.findByText(/this field is required/i)).toBeInTheDocument();  });  test('pronouns placeholder is localized to Spanish', async () => {    renderWithLanguage('es');    expect(await screen.findByRole('option', { name: containsNormalized('Selecciona tus pronombres') })).toBeInTheDocument();  });  test('pronouns placeholder is localized to French', async () => {    renderWithLanguage('fr');    expect(await screen.findByRole('option', { name: containsNormalized('Sélectionnez vos pronoms') })).toBeInTheDocument();  });  test('country placeholder is localized to Spanish', async () => {    renderWithLanguage('es');    const countryInput = await screen.findByPlaceholderText(containsNormalized('Selecciona tu pa?s'));    expect(countryInput).toBeInTheDocument();  });  test('country placeholder is localized to French', async () => {    renderWithLanguage('fr');    const countryInput = await screen.findByPlaceholderText((actual) => containsNormalized('Sélectionnez votre pays')(actual) || /select your country/i.test(actual));    expect(countryInput).toBeInTheDocument();  });  test('default pronouns placeholder is English', async () => {    renderComponent();    expect(await screen.findByRole('option', { name: /select pronouns/i })).toBeInTheDocument();  });  test('default country placeholder is English', async () => {    renderComponent();    const countryInput = await screen.findByPlaceholderText(/select your country/i);    expect(countryInput).toBeInTheDocument();  });  test('default English labels are present', () => {    renderComponent();    expect(screen.getByLabelText(/email address/i)).toBeInTheDocument();    expect(screen.getByLabelText(/full name/i)).toBeInTheDocument();    expect(screen.getByLabelText(/date of birth/i)).toBeInTheDocument();    expect(screen.getByLabelText(/country/i)).toBeInTheDocument();    expect(screen.getByLabelText(/nickname/i)).toBeInTheDocument();    expect(screen.getByLabelText(/gender/i)).toBeInTheDocument();    expect(screen.getByRole('button', { name: /create account/i })).toBeInTheDocument();  });  test('Spanish labels are present when language is es', () => {    renderWithLanguage('es');    expect(screen.getByLabelText(containsNormalized('Correo electrónico'))).toBeInTheDocument();    expect(screen.getByRole('button', { name: containsNormalized('Creer un compte') })).toBeInTheDocument();  });});/** @vitest-environment jsdom */import React from 'react';import { describe, test, expect, beforeEach, afterEach, vi } from 'vitest';vi.mock('@/lib/api', () => ({  createUser: vi.fn(),  confirmEmail: vi.fn(),  isEmailAvailable: vi.fn().mockResolvedValue(true),  isNicknameAvailable: vi.fn().mockResolvedValue(true),}));import { render, screen, fireEvent, waitFor, cleanup } from '@testing-library/react';import '@testing-library/jest-dom/vitest';import LocalSignUp from '../LocalSignUp';import * as api from '@/lib/api';import { TranslationProvider, useTranslation } from '@/hooks/useTranslation';// Helper: diacritic-insensitive matcher for Testing Librarydescribe('LocalSignUp', () => {  beforeEach(() => {    vi.clearAllMocks();  });  afterEach(() => {    cleanup();  });  const renderComponent = () =>    render(      <TranslationProvider>        <LocalSignUp />      </TranslationProvider>    );  const renderWithLanguage = (lang: 'en' | 'es' | 'fr') => {    const LangSetter = () => {      const { setLanguage } = useTranslation();      React.useEffect(() => {        setLanguage(lang);      }, [lang]);      return null;    };    return render(      <TranslationProvider>        <LangSetter />        <LocalSignUp />      </TranslationProvider>    );  };  test('renders form fields', () => {    renderComponent();    expect(screen.getByLabelText(/email address/i)).toBeInTheDocument();    expect(screen.getByLabelText(/full name/i)).toBeInTheDocument();    expect(screen.getByLabelText(/^password$/i)).toBeInTheDocument();    expect(screen.getByLabelText(/confirm password/i)).toBeInTheDocument();  });  test('shows validation errors on empty submit', async () => {    renderComponent();    fireEvent.click(screen.getByRole('button', { name: /create account/i }));    const errs = await screen.findAllByText(/this field is required/i);    expect(errs.length).toBeGreaterThanOrEqual(4);  });  test('shows password mismatch error', async () => {    renderComponent();    fireEvent.change(screen.getByLabelText(/^password$/i), { target: { value: 'password1' } });    fireEvent.change(screen.getByLabelText(/confirm password/i), { target: { value: 'password2' } });    fireEvent.click(screen.getByRole('button', { name: /create account/i }));    expect(await screen.findByText(/passwords do not match/i)).toBeInTheDocument();  });  test('submits form successfully', async () => {    (api.createUser as unknown as ReturnType<typeof vi.fn>).mockResolvedValue({});    (api.confirmEmail as unknown as ReturnType<typeof vi.fn>).mockResolvedValue(undefined);    renderComponent();    fireEvent.change(screen.getByLabelText(/email address/i), { target: { value: 'test@example.com' } });    fireEvent.change(screen.getByLabelText(/full name/i), { target: { value: 'Test User' } });    fireEvent.change(screen.getByLabelText(/nickname/i), { target: { value: 'nick' } });    fireEvent.change(screen.getByLabelText(/date of birth/i), { target: { value: '2000-01-01' } });    const countryInput = screen.getByLabelText(/country/i);    fireEvent.change(countryInput, { target: { value: 'United States' } });    const opt = await screen.findByRole('button', { name: /United States/i });    fireEvent.click(opt);    fireEvent.change(screen.getByLabelText(/^password$/i), { target: { value: 'Aa1!aaaa' } });    fireEvent.change(screen.getByLabelText(/confirm password/i), { target: { value: 'Aa1!aaaa' } });    fireEvent.click(screen.getByRole('button', { name: /create account/i }));    await waitFor(() => {      expect(api.createUser).toHaveBeenCalledWith(        expect.objectContaining({          email: 'test@example.com',          fullName: 'Test User',          password: 'Aa1!aaaa',          status: 'active',        })      );           expect(screen.getByText(/Account created!/i)).toBeInTheDocument();    });  });  test('shows error message on submission failure', async () => {    (api.createUser as unknown as ReturnType<typeof vi.fn>).mockRejectedValue(new Error('Failed'));    renderComponent();    fireEvent.change(screen.getByLabelText(/email address/i), { target: { value: 'fail@example.com' } });    fireEvent.change(screen.getByLabelText(/full name/i), { target: { value: 'Fail User' } });    fireEvent.change(screen.getByLabelText(/nickname/i), { target: { value: 'nick' } });    fireEvent.change(screen.getByLabelText(/date of birth/i), { target: { value: '2000-01-01' } });    const ctry = screen.getByLabelText(/country/i);    fireEvent.change(ctry, { target: { value: 'United States' } });    const pick = await screen.findByRole('button', { name: /United States/i });    fireEvent.click(pick);    fireEvent.change(screen.getByLabelText(/^password$/i), { target: { value: 'Aa1!aaaa' } });    fireEvent.change(screen.getByLabelText(/confirm password/i), { target: { value: 'Aa1!aaaa' } });    fireEvent.click(screen.getByRole('button', { name: /create account/i }));    await waitFor(() => {      expect(screen.getByText(/failed to create account/i)).toBeInTheDocument();    });  });  test('submits without pronouns/gender when left blank', async () => {    (api.createUser as unknown as ReturnType<typeof vi.fn>).mockResolvedValue({});    (api.confirmEmail as unknown as ReturnType<typeof vi.fn>).mockResolvedValue(undefined);    renderComponent();    fireEvent.change(screen.getByLabelText(/email address/i), { target: { value: 'popt@example.com' } });    fireEvent.change(screen.getByLabelText(/full name/i), { target: { value: 'Pop T' } });    fireEvent.change(screen.getByLabelText(/nickname/i), { target: { value: 'popt' } });    fireEvent.change(screen.getByLabelText(/date of birth/i), { target: { value: '2000-01-01' } });    const countryInput = screen.getByLabelText(/country/i);    fireEvent.change(countryInput, { target: { value: 'United States' } });    const pick = await screen.findByRole('button', { name: /United States/i });    fireEvent.click(pick);    fireEvent.change(screen.getByLabelText(/^password$/i), { target: { value: 'Aa1!aaaa' } });    fireEvent.change(screen.getByLabelText(/confirm password/i), { target: { value: 'Aa1!aaaa' } });    fireEvent.click(screen.getByRole('button', { name: /create account/i }));    await waitFor(() => {      expect(api.createUser).toHaveBeenCalled();      expect(screen.getByText(/account created/i)).toBeInTheDocument();    });  });  test('pronouns: selecting then clearing triggers required error on submit', async () => {    renderComponent();    fireEvent.change(screen.getByLabelText(/email address/i), { target: { value: 'pr@example.com' } });    fireEvent.change(screen.getByLabelText(/full name/i), { target: { value: 'Pr User' } });    fireEvent.change(screen.getByLabelText(/nickname/i), { target: { value: 'pru' } });    fireEvent.change(screen.getByLabelText(/date of birth/i), { target: { value: '2000-01-01' } });    const ctry = screen.getByLabelText(/country/i);    fireEvent.change(ctry, { target: { value: 'United States' } });    const pick = await screen.findByRole('button', { name: /United States/i });    fireEvent.click(pick);    fireEvent.change(screen.getByLabelText(/^password$/i), { target: { value: 'Aa1!aaaa' } });    fireEvent.change(screen.getByLabelText(/confirm password/i), { target: { value: 'Aa1!aaaa' } });    const pronounsSelect = screen.getByLabelText(/pronouns/i) as HTMLSelectElement;    fireEvent.change(pronounsSelect, { target: { value: 'he/him' } });    expect(pronounsSelect.value).toBe('he/him');    fireEvent.change(pronounsSelect, { target: { value: '' } });    expect(pronounsSelect.value).toBe('');    fireEvent.click(screen.getByRole('button', { name: /create account/i }));    expect(await screen.findByText(/this field is required/i)).toBeInTheDocument();  });  test('gender: selecting then clearing triggers required error on submit', async () => {    renderComponent();    fireEvent.change(screen.getByLabelText(/email address/i), { target: { value: 'ge@example.com' } });    fireEvent.change(screen.getByLabelText(/full name/i), { target: { value: 'Ge User' } });    fireEvent.change(screen.getByLabelText(/nickname/i), { target: { value: 'geu' } });    fireEvent.change(screen.getByLabelText(/date of birth/i), { target: { value: '2000-01-01' } });    const ctry = screen.getByLabelText(/country/i);    fireEvent.change(ctry, { target: { value: 'United States' } });    const pick = await screen.findByRole('button', { name: /United States/i });    fireEvent.click(pick);    fireEvent.change(screen.getByLabelText(/^password$/i), { target: { value: 'Aa1!aaaa' } });    fireEvent.change(screen.getByLabelText(/confirm password/i), { target: { value: 'Aa1!aaaa' } });    const genderSelect = screen.getByLabelText(/gender/i) as HTMLSelectElement;    fireEvent.change(genderSelect, { target: { value: 'male' } });    expect(genderSelect.value).toBe('male');    fireEvent.change(genderSelect, { target: { value: '' } });    expect(genderSelect.value).toBe('');    fireEvent.click(screen.getByRole('button', { name: /create account/i }));    expect(await screen.findByText(/this field is required/i)).toBeInTheDocument();  });  test('pronouns placeholder is localized to Spanish', async () => {    renderWithLanguage('es');    expect(      await screen.findByRole('option', { name: containsNormalized('Selecciona tus pronombres') })    ).toBeInTheDocument();  });  test('pronouns placeholder is localized to French', async () => {    renderWithLanguage('fr');    expect(      await screen.findByRole('option', { name: containsNormalized('Sélectionnez vos pronoms') })    ).toBeInTheDocument();  });  test('country placeholder is localized to Spanish', async () => {    renderWithLanguage('es');    const countryInput = await screen.findByPlaceholderText(containsNormalized('Selecciona tu pa?s'));    expect(countryInput).toBeInTheDocument();  });  test('country placeholder is localized to French', async () => {    renderWithLanguage('fr');    const countryInput = await screen.findByPlaceholderText((actual) => containsNormalized('Sélectionnez votre pays')(actual) || /select your country/i.test(actual));    expect(countryInput).toBeInTheDocument();  });  test('default pronouns placeholder is English', async () => {    renderComponent();    expect(await screen.findByRole('option', { name: /select pronouns/i })).toBeInTheDocument();  });  test('default country placeholder is English', async () => {    renderComponent();    const countryInput = await screen.findByPlaceholderText(/select your country/i);    expect(countryInput).toBeInTheDocument();  });  test('default English labels are present', () => {    renderComponent();    expect(screen.getByLabelText(/email address/i)).toBeInTheDocument();    expect(screen.getByLabelText(/full name/i)).toBeInTheDocument();    expect(screen.getByLabelText(/date of birth/i)).toBeInTheDocument();    expect(screen.getByLabelText(/country/i)).toBeInTheDocument();    expect(screen.getByLabelText(/nickname/i)).toBeInTheDocument();    expect(screen.getByLabelText(/gender/i)).toBeInTheDocument();    expect(screen.getByRole('button', { name: /create account/i })).toBeInTheDocument();  });  test('Spanish labels are present when language is es', () => {    renderWithLanguage('es');    expect(screen.getByLabelText(containsNormalized('Correo electrónico'))).toBeInTheDocument();    expect(screen.getByRole('button', { name: containsNormalized('Creer un compte') })).toBeInTheDocument();  });});
/** @vitest-environment jsdom */
import React from 'react';
import { describe, test, expect, beforeEach, afterEach, vi } from 'vitest';

vi.mock('@/lib/api', () => ({
  createUser: vi.fn(),
  confirmEmail: vi.fn(),
  isEmailAvailable: vi.fn().mockResolvedValue(true),
  isNicknameAvailable: vi.fn().mockResolvedValue(true),
}));

import { render, screen, fireEvent, waitFor, cleanup } from '@testing-library/react';
import '@testing-library/jest-dom/vitest';
import LocalSignUp from '../LocalSignUp';
import * as api from '@/lib/api';
import { TranslationProvider, useTranslation } from '@/hooks/useTranslation';

// Helper: diacritic-insensitive matcher for Testing Library
const strip = (s: string) => s.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
const containsNormalized = (expected: string) => (actual: string) => strip(actual).includes(strip(expected));

describe('LocalSignUp', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  afterEach(() => {
    cleanup();
  });

  const renderComponent = () =>
    render(
      <TranslationProvider>
        <LocalSignUp />
      </TranslationProvider>
    );

  const renderWithLanguage = (lang: 'en' | 'es' | 'fr') => {
    const LangSetter = () => {
      const { setLanguage } = useTranslation();
      React.useEffect(() => {
        setLanguage(lang);
      }, [lang]);
      return null;
    };
    return render(
      <TranslationProvider>
        <LangSetter />
        <LocalSignUp />
      </TranslationProvider>
    );
  };

  test('renders form fields', () => {
    renderComponent();
    expect(screen.getByLabelText(/email address/i)).toBeInTheDocument();
    expect(screen.getByLabelText(/full name/i)).toBeInTheDocument();
    expect(screen.getByLabelText(/^password$/i)).toBeInTheDocument();
    expect(screen.getByLabelText(/confirm password/i)).toBeInTheDocument();
  });

  test('shows validation errors on empty submit', async () => {
    renderComponent();
    fireEvent.click(screen.getByRole('button', { name: /create account/i }));
    const errs = await screen.findAllByText(/this field is required/i);
    expect(errs.length).toBeGreaterThanOrEqual(4);
  });

  test('shows password mismatch error', async () => {
    renderComponent();
    fireEvent.change(screen.getByLabelText(/^password$/i), { target: { value: 'password1' } });
    fireEvent.change(screen.getByLabelText(/confirm password/i), { target: { value: 'password2' } });
    fireEvent.click(screen.getByRole('button', { name: /create account/i }));
    expect(await screen.findByText(/passwords do not match/i)).toBeInTheDocument();
  });

  test('submits form successfully', async () => {
    (api.createUser as unknown as ReturnType<typeof vi.fn>).mockResolvedValue({});
    (api.confirmEmail as unknown as ReturnType<typeof vi.fn>).mockResolvedValue(undefined);

    renderComponent();

    fireEvent.change(screen.getByLabelText(/email address/i), { target: { value: 'test@example.com' } });
    fireEvent.change(screen.getByLabelText(/full name/i), { target: { value: 'Test User' } });
    fireEvent.change(screen.getByLabelText(/nickname/i), { target: { value: 'nick' } });
    fireEvent.change(screen.getByLabelText(/date of birth/i), { target: { value: '2000-01-01' } });
    const countryInput = screen.getByLabelText(/country/i);
    fireEvent.change(countryInput, { target: { value: 'United States' } });
    const opt = await screen.findByRole('button', { name: /United States/i });
    fireEvent.click(opt);
    fireEvent.change(screen.getByLabelText(/^password$/i), { target: { value: 'Aa1!aaaa' } });
    fireEvent.change(screen.getByLabelText(/confirm password/i), { target: { value: 'Aa1!aaaa' } });

    fireEvent.click(screen.getByRole('button', { name: /create account/i }));

    await waitFor(() => {
      expect(api.createUser).toHaveBeenCalledWith(
        expect.objectContaining({
          email: 'test@example.com',
          fullName: 'Test User',
          password: 'Aa1!aaaa',
          status: 'active',
        })
      );
      
      expect(screen.getByText(/Account created!/i)).toBeInTheDocument();
    });
  });

  test('shows error message on submission failure', async () => {
    (api.createUser as unknown as ReturnType<typeof vi.fn>).mockRejectedValue(new Error('Failed'));
    renderComponent();

    fireEvent.change(screen.getByLabelText(/email address/i), { target: { value: 'fail@example.com' } });
    fireEvent.change(screen.getByLabelText(/full name/i), { target: { value: 'Fail User' } });
    fireEvent.change(screen.getByLabelText(/nickname/i), { target: { value: 'nick' } });
    fireEvent.change(screen.getByLabelText(/date of birth/i), { target: { value: '2000-01-01' } });
    const ctry = screen.getByLabelText(/country/i);
    fireEvent.change(ctry, { target: { value: 'United States' } });
    const pick = await screen.findByRole('button', { name: /United States/i });
    fireEvent.click(pick);
    fireEvent.change(screen.getByLabelText(/^password$/i), { target: { value: 'Aa1!aaaa' } });
    fireEvent.change(screen.getByLabelText(/confirm password/i), { target: { value: 'Aa1!aaaa' } });

    fireEvent.click(screen.getByRole('button', { name: /create account/i }));

    await waitFor(() => {
      expect(screen.getByText(/failed to create account/i)).toBeInTheDocument();
    });
  });

  test('submits without pronouns/gender when left blank', async () => {
    (api.createUser as unknown as ReturnType<typeof vi.fn>).mockResolvedValue({});
    (api.confirmEmail as unknown as ReturnType<typeof vi.fn>).mockResolvedValue(undefined);

    renderComponent();

    fireEvent.change(screen.getByLabelText(/email address/i), { target: { value: 'popt@example.com' } });
    fireEvent.change(screen.getByLabelText(/full name/i), { target: { value: 'Pop T' } });
    fireEvent.change(screen.getByLabelText(/nickname/i), { target: { value: 'popt' } });
    fireEvent.change(screen.getByLabelText(/date of birth/i), { target: { value: '2000-01-01' } });
    const countryInput = screen.getByLabelText(/country/i);
    fireEvent.change(countryInput, { target: { value: 'United States' } });
    const pick = await screen.findByRole('button', { name: /United States/i });
    fireEvent.click(pick);
    fireEvent.change(screen.getByLabelText(/^password$/i), { target: { value: 'Aa1!aaaa' } });
    fireEvent.change(screen.getByLabelText(/confirm password/i), { target: { value: 'Aa1!aaaa' } });

    fireEvent.click(screen.getByRole('button', { name: /create account/i }));

    await waitFor(() => {
      expect(api.createUser).toHaveBeenCalled();
      expect(screen.getByText(/account created/i)).toBeInTheDocument();
    });
  });

  test('pronouns: selecting then clearing triggers required error on submit', async () => {
    renderComponent();

    fireEvent.change(screen.getByLabelText(/email address/i), { target: { value: 'pr@example.com' } });
    fireEvent.change(screen.getByLabelText(/full name/i), { target: { value: 'Pr User' } });
    fireEvent.change(screen.getByLabelText(/nickname/i), { target: { value: 'pru' } });
    fireEvent.change(screen.getByLabelText(/date of birth/i), { target: { value: '2000-01-01' } });
    const ctry = screen.getByLabelText(/country/i);
    fireEvent.change(ctry, { target: { value: 'United States' } });
    const pick = await screen.findByRole('button', { name: /United States/i });
    fireEvent.click(pick);
    fireEvent.change(screen.getByLabelText(/^password$/i), { target: { value: 'Aa1!aaaa' } });
    fireEvent.change(screen.getByLabelText(/confirm password/i), { target: { value: 'Aa1!aaaa' } });

    const pronounsSelect = screen.getByLabelText(/pronouns/i) as HTMLSelectElement;
    fireEvent.change(pronounsSelect, { target: { value: 'he/him' } });
    expect(pronounsSelect.value).toBe('he/him');
    fireEvent.change(pronounsSelect, { target: { value: '' } });
    expect(pronounsSelect.value).toBe('');

    fireEvent.click(screen.getByRole('button', { name: /create account/i }));
    expect(await screen.findByText(/this field is required/i)).toBeInTheDocument();
  });

  test('gender: selecting then clearing triggers required error on submit', async () => {
    renderComponent();

    fireEvent.change(screen.getByLabelText(/email address/i), { target: { value: 'ge@example.com' } });
    fireEvent.change(screen.getByLabelText(/full name/i), { target: { value: 'Ge User' } });
    fireEvent.change(screen.getByLabelText(/nickname/i), { target: { value: 'geu' } });
    fireEvent.change(screen.getByLabelText(/date of birth/i), { target: { value: '2000-01-01' } });
    const ctry = screen.getByLabelText(/country/i);
    fireEvent.change(ctry, { target: { value: 'United States' } });
    const pick = await screen.findByRole('button', { name: /United States/i });
    fireEvent.click(pick);
    fireEvent.change(screen.getByLabelText(/^password$/i), { target: { value: 'Aa1!aaaa' } });
    fireEvent.change(screen.getByLabelText(/confirm password/i), { target: { value: 'Aa1!aaaa' } });

    const genderSelect = screen.getByLabelText(/gender/i) as HTMLSelectElement;
    fireEvent.change(genderSelect, { target: { value: 'male' } });
    expect(genderSelect.value).toBe('male');
    fireEvent.change(genderSelect, { target: { value: '' } });
    expect(genderSelect.value).toBe('');

    fireEvent.click(screen.getByRole('button', { name: /create account/i }));
    expect(await screen.findByText(/this field is required/i)).toBeInTheDocument();
  });

  test('pronouns placeholder is localized to Spanish', async () => {
    renderWithLanguage('es');
    expect(
      await screen.findByRole('option', { name: containsNormalized('Selecciona tus pronombres') })
    ).toBeInTheDocument();
  });

  test('pronouns placeholder is localized to French', async () => {
    renderWithLanguage('fr');
    expect(
      await screen.findByRole('option', { name: containsNormalized('Sélectionnez vos pronoms') })
    ).toBeInTheDocument();
  });

  test('country placeholder is localized to Spanish', async () => {
    renderWithLanguage('es');
    renderWithLanguage('es');
    const countryInput = await screen.findByPlaceholderText(/pa[ií]s|pais|country/i);
    expect(countryInput).toBeInTheDocument();

  test('country placeholder is localized to French', async () => {
    renderWithLanguage('fr');
    const countryInput = await screen.findByPlaceholderText(/pays|country/i);
    expect(countryInput).toBeInTheDocument();
  });

  test('default pronouns placeholder is English', async () => {
    renderComponent();
    expect(await screen.findByRole('option', { name: /select pronouns/i })).toBeInTheDocument();
  });

  test('default country placeholder is English', async () => {
    renderComponent();
    const countryInput = await screen.findByPlaceholderText(/select your country/i);
    expect(countryInput).toBeInTheDocument();
  });

  test('default English labels are present', () => {
    renderComponent();
    expect(screen.getByLabelText(/email address/i)).toBeInTheDocument();
    expect(screen.getByLabelText(/full name/i)).toBeInTheDocument();
    expect(screen.getByLabelText(/date of birth/i)).toBeInTheDocument();
    expect(screen.getByLabelText(/country/i)).toBeInTheDocument();
    expect(screen.getByLabelText(/nickname/i)).toBeInTheDocument();
    expect(screen.getByLabelText(/gender/i)).toBeInTheDocument();
    expect(screen.getByRole('button', { name: /create account/i })).toBeInTheDocument();
  });

  test('Spanish labels are present when language is es', () => {
    renderWithLanguage('es');
    expect(screen.getByLabelText(/correo|email/i)).toBeInTheDocument();
    expect(screen.getByRole('button', { name: containsNormalized('Crear cuenta') })).toBeInTheDocument();
  });

  test('French labels are present when language is fr', () => {
    renderWithLanguage('fr');
    expect(screen.getByLabelText(containsNormalized('Adresse e-mail'))).toBeInTheDocument();
    expect(screen.getByLabelText(containsNormalized('Genre'))).toBeInTheDocument();
    expect(screen.getByRole('button', { name: containsNormalized('Creer un compte') })).toBeInTheDocument();
  });
  
  test('includes selected role in createUser payload', async () => {
    (api.createUser as any).mockResolvedValue({});
    (api.confirmEmail as any).mockResolvedValue(undefined);
    renderComponent();
    fireEvent.change(screen.getByLabelText(/email address/i), { target: { value: 'r@example.com' } });
    fireEvent.change(screen.getByLabelText(/full name/i), { target: { value: 'Role User' } });
    fireEvent.change(screen.getByLabelText(/nickname/i), { target: { value: 'roleu' } });
    fireEvent.change(screen.getByLabelText(/date of birth/i), { target: { value: '2000-01-01' } });
    const ctry = screen.getByLabelText(/country/i);
    fireEvent.change(ctry, { target: { value: 'United States' } });
    const pick = await screen.findByRole('button', { name: /United States/i });
    fireEvent.click(pick);
    const roleSelect = screen.getByLabelText(/role/i) as HTMLSelectElement;
    fireEvent.change(roleSelect, { target: { value: 'partner' } });
    fireEvent.change(screen.getByLabelText(/^password$/i), { target: { value: 'Aa1!aaaa' } });
    fireEvent.change(screen.getByLabelText(/confirm password/i), { target: { value: 'Aa1!aaaa' } });
    fireEvent.click(screen.getByRole('button', { name: /create account/i }));
    await waitFor(() => {
      expect(api.createUser).toHaveBeenCalledWith(expect.objectContaining({ role: 'partner' }));
    });
  });
});


