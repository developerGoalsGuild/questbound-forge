# ---------------------------------------
# schema.graphql (AppSync-compatible)
# Default auth: AWS Lambda (Lambda Authorizer)
# Additional auth: API Key (for the few public ops below)
# ---------------------------------------

# AWS Scalars
scalar AWSDateTime
scalar AWSDate
scalar AWSTimestamp
scalar AWSJSON

# Enums
enum GoalStatus {
  active
  paused
  completed
  archived
}

enum TaskStatus {
  active
  paused
  completed
  cancelled
}

enum QuestStatus {
  draft
  active
  completed
  cancelled
  fai
  
  led
}

enum QuestKind {
  linked
  quantitative
}

enum QuestCountScope {
  completed_tasks
  completed_goals
}

# ----------------
# Core Types
# ----------------

type NotificationPreferences {
  questStarted: Boolean!
  questCompleted: Boolean!
  questFailed: Boolean!
  progressMilestones: Boolean!
  deadlineWarnings: Boolean!
  streakAchievements: Boolean!
  challengeUpdates: Boolean!
  channels: NotificationChannels!
}

type NotificationChannels {
  inApp: Boolean!
  email: Boolean!
  push: Boolean!
}

type User {
  id: ID!
  email: String
  role: String!                 # "user" | "partner" | "patron"
  fullName: String
  nickname: String
  birthDate: AWSDate
  status: String
  country: String
  language: String
  gender: String
  pronouns: String
  bio: String
  tags: [String!]!
  tier: String!                 # "free" | "premium" etc.
  notificationPreferences: NotificationPreferences
  createdAt: AWSTimestamp
  updatedAt: AWSTimestamp
  ageYears: Int
}

# Typed answer pair for goals
type Answer {
  key: String!
  answer: String!
}

input AnswerInput {
  key: String!
  answer: String!
}

type Goal {
  id: ID!
  userId: ID!
  title: String!
  description: String
  category: String
  tags: [String!]
  deadline: AWSDate
  status: GoalStatus!
  createdAt: AWSTimestamp
  updatedAt: AWSTimestamp
  answers: [Answer!]
  # Progress fields
  progress: Float
  milestones: [Milestone!]
  completedTasks: Int
  totalTasks: Int
}

# Task type (simplified for example)
type Task {
  id: ID!
  goalId: ID!
  title: String!
  dueAt: Int!
  status: TaskStatus!
  createdAt: AWSTimestamp!
  updatedAt: AWSTimestamp!
  tags: [String!]!
}

# Milestone type for progress tracking
type Milestone {
  id: ID!
  name: String!
  percentage: Float!
  achieved: Boolean!
  achievedAt: AWSTimestamp
  description: String
}

# Goal progress type for detailed progress information
type GoalProgress {
  goalId: ID!
  progressPercentage: Float!
  taskProgress: Float!
  timeProgress: Float!
  completedTasks: Int!
  totalTasks: Int!
  milestones: [Milestone!]!
  lastUpdated: AWSTimestamp!
  isOverdue: Boolean!
  isUrgent: Boolean!
}

# Simplified task type for progress calculation (no redundant fields)
type TaskForProgress {
  id: ID!
  dueAt: Int!
  status: TaskStatus!
  createdAt: AWSTimestamp!
  updatedAt: AWSTimestamp!
}

# Goal with tasks type for frontend progress calculation
type GoalWithTasks {
  id: ID!
  title: String!
  deadline: AWSDate!
  status: GoalStatus!
  createdAt: AWSTimestamp!
  tasks: [TaskForProgress!]!
}

# Quest type for user-created quests
type Quest {
  id: ID!
  userId: ID!
  title: String!
  description: String
  difficulty: String!
  rewardXp: Int!
  status: QuestStatus!
  category: String!
  tags: [String!]!
  privacy: String!
  deadline: AWSTimestamp
  createdAt: AWSTimestamp!
  updatedAt: AWSTimestamp!
  startedAt: AWSTimestamp
  completedAt: AWSTimestamp
  kind: QuestKind!
  linkedGoalIds: [ID!]
  linkedTaskIds: [ID!]
  dependsOnQuestIds: [ID!]
  # Quantitative fields
  targetCount: Int
  countScope: QuestCountScope
  periodDays: Int
}

type Message @aws_lambda {
  id: ID!
  roomId: ID!
  senderId: ID!
  senderNickname: String
  text: String!
  ts: AWSTimestamp!
  emojiMetadata: EmojiMetadata
}

type EmojiMetadata {
  shortcodes: [String!]!
  unicodeCount: Int!
}

type Reaction {
  shortcode: String!
  unicode: String!
  count: Int!
  viewerHasReacted: Boolean!
}

type ReactionResponse {
  messageId: ID!
  shortcode: String!
  unicode: String!
  count: Int!
  added: Boolean
  removed: Boolean
}

type Offer {
  id: ID!
  title: String!
  url: String!
  tags: [String!]
  validTo: AWSDateTime
}

# ----------------
# Queries
# ----------------

type Query {
  me: User
  user(userId: ID!): User
  goals(userId: ID!): [Goal!]!
  goal(goalId: ID!): Goal
  activeGoalsCount(userId: ID!): Int!
  myGoals: [Goal!]!
  myDashboardGoals(limit: Int, status: String, sortBy: String): [Goal!]!
  myTasks(goalId: ID!): [Task!]!
  tasks(goalId: ID!): [Task!]!
  messages(roomId: ID!, after: AWSTimestamp, limit: Int = 50): [Message!]! @aws_lambda
  reactions(messageId: ID!): [Reaction!]! @aws_lambda
  offers(tags: [String!], limit: Int = 20): [Offer!]!
  
  # Progress queries
  goalProgress(goalId: ID!): GoalProgress!
  myGoalsProgress: [GoalProgress!]!
  
  # Raw data queries for frontend progress calculation
  myGoalsWithTasks: [GoalWithTasks!]!

  # Authenticated profile query: returns only caller's profile
  myProfile: User!

  # Public checks (API key)
  isEmailAvailable(email: String!): Boolean! @aws_api_key
  isNicknameAvailable(nickname: String!): Boolean! @aws_api_key
  
  # Authorized checks (Lambda auth)
  isNicknameAvailableForUser(nickname: String!): Boolean!
  
  # Quest queries
  myQuests(goalId: ID): [Quest!]!
}

# ----------------
# Mutations
# ----------------

type Mutation {
  """
  Create a user profile. Accepts a bcrypt password hash (NEVER plaintext).
  The resolver sets tier to 'free' by default.
  """
  createUser(input: CreateUserInput!): User! @aws_api_key 

  """
  Post a message to a chat room.
  """
  sendMessage(roomId: ID!, text: String!, senderNickname: String): Message! @aws_lambda
  
  """
  Add a reaction to a message (idempotent per user/emoji).
  """
  addReaction(messageId: ID!, shortcode: String!, unicode: String!): ReactionResponse! @aws_lambda
  
  """
  Remove current user's reaction for a given emoji (idempotent).
  """
  removeReaction(messageId: ID!, shortcode: String!): ReactionResponse! @aws_lambda
  
  """
  Non-public mutation to create a new task associated with a goal.
  Requires authentication.
  """
  createTask(input: TaskInput!): Task!
}

# ----------------
# Subscriptions
# ----------------

type Subscription {
  """
  Subscribe to new messages for a room. Requires the same roomId as in sendMessage.
  """
  onMessage(roomId: ID!): Message @aws_lambda
  @aws_subscribe(mutations: ["sendMessage"])

  """
  Subscribe to reaction updates for a specific message.
  """
  onReaction(messageId: ID!): ReactionResponse
    @aws_subscribe(mutations: ["addReaction", "removeReaction"])
}

# ----------------
# Inputs
# ----------------

input CreateUserInput {
  email: String!
  fullName: String!
  nickname: String!
  birthDate: AWSDate
  status: String
  country: String!
  language: String = "en"
  gender: String
  pronouns: String
  bio: String
  tags: [String!]
  passwordHash: String       # bcrypt hash; hashing is done outside this API
  password: String           # DEV ONLY: plaintext accepted for non-production
}

input GoalInput {
  title: String!
  description: String
  category: String
  tags: [String!]
  deadline: AWSDate!    # required to match resolver validation
  answers: [AnswerInput!]
}




# Input type for Task creation, including tags consistent with goals
input TaskInput {
  goalId: ID!
  title: String!
  dueAt: Int! # epoch seconds
  tags: [String!]! # tags consistent with goals
}



# Non-public mutation for creating a task
# Note: createTask is now included in the main Mutation type below


# ----------------
# Root Schema
# ----------------

schema {
  query: Query
  mutation: Mutation
  subscription: Subscription
}
