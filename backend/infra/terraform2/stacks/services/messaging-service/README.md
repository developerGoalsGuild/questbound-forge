# Messaging Service Infrastructure

This directory contains the Terraform configuration for deploying the GoalsGuild messaging service.

## Overview

The messaging service is a FastAPI-based WebSocket service that provides real-time messaging capabilities for the GoalsGuild application. It supports both general chat rooms and guild-specific messaging.

## Architecture

- **ECS Fargate**: Containerized FastAPI service
- **Application Load Balancer**: HTTP/WebSocket load balancing
- **DynamoDB**: Message storage (gg_core and guild tables)
- **CloudWatch**: Logging and monitoring
- **Secrets Manager**: JWT secret storage
- **ECR**: Docker image repository

## Prerequisites

1. **Database Stack**: Must be deployed first to provide DynamoDB table references
2. **Security Stack**: Must be deployed for IAM roles and policies
3. **VPC Configuration**: VPC, subnets, and security groups must be configured
4. **Docker Image**: Messaging service Docker image must be built and pushed to ECR

## Deployment

### Using the Deployment Script

```powershell
# Deploy to dev environment
.\scripts\deploy-messaging-service-with-build.ps1 -Env dev

# Deploy to staging environment
.\scripts\deploy-messaging-service-with-build.ps1 -Env staging

# Deploy to production environment
.\scripts\deploy-messaging-service-with-build.ps1 -Env prod
```

### Manual Deployment

1. **Configure Variables**:
   ```bash
   cp terraform.tfvars.example terraform.tfvars
   # Edit terraform.tfvars with your values
   ```

2. **Initialize Terraform**:
   ```bash
   terraform init
   ```

3. **Plan Deployment**:
   ```bash
   terraform plan
   ```

4. **Apply Configuration**:
   ```bash
   terraform apply
   ```

## Configuration

### Required Variables

- `environment`: Environment name (dev, staging, prod)
- `aws_region`: AWS region
- `terraform_state_bucket`: S3 bucket for Terraform state
- `vpc_id`: VPC ID for deployment
- `vpc_cidr`: VPC CIDR block
- `public_subnet_ids`: Public subnet IDs for ALB
- `private_subnet_ids`: Private subnet IDs for ECS service
- `jwt_secret`: JWT secret for authentication

### Optional Variables

- `existing_image_uri`: Docker image URI (auto-generated by deployment script)
- `task_cpu`: CPU units for ECS task (default: 256)
- `task_memory`: Memory for ECS task (default: 512)
- `desired_count`: Number of service instances (default: 1)

## Outputs

- `ecr_repository_url`: ECR repository URL
- `ecs_cluster_name`: ECS cluster name
- `ecs_service_name`: ECS service name
- `alb_dns_name`: ALB DNS name
- `messaging_service_url`: HTTP URL for the service
- `websocket_url`: WebSocket URL for real-time messaging
- `cloudwatch_log_group`: CloudWatch log group name
- `security_group_id`: Security group ID
- `target_group_arn`: Target group ARN

## Features

### Real-time Messaging
- WebSocket connections for real-time communication
- Message broadcasting to room participants
- Typing indicators and user presence

### Room Management
- General chat rooms (stored in gg_core table)
- Guild-specific rooms (stored in guild table)
- Automatic room type detection

### Security
- JWT token authentication
- Rate limiting to prevent spam
- Guild membership validation
- Secure WebSocket connections

### Monitoring
- CloudWatch logging
- Health checks
- ECS service monitoring
- ALB metrics

## Dependencies

- Database stack (DynamoDB tables)
- Security stack (IAM roles)
- VPC configuration
- ECR repository

## Troubleshooting

### Common Issues

1. **Database Connection**: Ensure database stack is deployed first
2. **VPC Configuration**: Verify subnet IDs and security groups
3. **Image URI**: Check that Docker image is built and pushed to ECR
4. **IAM Permissions**: Verify ECS task has necessary DynamoDB permissions

### Logs

Check CloudWatch logs for debugging:
```bash
aws logs describe-log-groups --log-group-name-prefix "/aws/ecs/goalsguild"
```

### Health Checks

Test the service health endpoint:
```bash
curl http://your-alb-dns-name/health
```

## Scaling

To scale the service:

1. **Horizontal Scaling**: Increase `desired_count` in terraform.tfvars
2. **Vertical Scaling**: Increase `task_cpu` and `task_memory`
3. **Auto Scaling**: Configure ECS auto scaling policies

## Security Considerations

- JWT secrets are stored in AWS Secrets Manager
- WebSocket connections use secure protocols
- Rate limiting prevents abuse
- Guild membership is validated before allowing access
- All traffic is encrypted in transit
