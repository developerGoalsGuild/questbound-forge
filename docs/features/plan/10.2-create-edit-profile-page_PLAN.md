# 10.2 – Create edit profile page - Feature Plan

## Overview
Create an edit profile page component that allows authenticated users to update their profile information. The page should provide a form-based interface with validation, accessibility features, and responsive design. This feature builds upon the existing profile view page and integrates with the user-service REST API for profile updates.

## Dependencies
- 8.1 (presumed user authentication and profile view functionality)
- Existing `ProfileView` component with "Edit Profile" button
- `useUserProfile` hook with `updateProfile` function
- User-service `PUT /profile` endpoint
- DynamoDB single-table profile storage pattern

## Technical Implementation

### Frontend Components

#### 1. Profile Models (`frontend/src/models/profile.ts`)
- **Location**: `frontend/src/models/profile.ts`
- **Purpose**: TypeScript interfaces and types for profile-related data
- **Contents**:
  - `ProfileFormData` interface for form state
  - `ProfileValidationErrors` interface for form errors
  - `CountryOption` interface for country dropdown
  - `LanguageOption` interface for language selection

#### 2. Profile API Service (`frontend/src/lib/apiProfile.ts`)
- **Location**: `frontend/src/lib/apiProfile.ts`
- **Purpose**: Dedicated API service for profile operations
- **Functions**:
  - `getProfile()`: Fetch user profile
  - `updateProfile(updates: ProfileUpdateInput)`: Update profile
  - `checkNicknameAvailability(nickname: string)`: Check nickname uniqueness
  - `getCountries()`: Get list of supported countries
  - `validateProfileField(field: string, value: any)`: Field-level validation

#### 3. Profile Translation File (`frontend/src/i18n/profile.ts`)
- **Location**: `frontend/src/i18n/profile.ts`
- **Purpose**: i18n translations for profile edit page
- **Structure**: Following project pattern with TypeScript interfaces
- **Languages**: English, Spanish, French
- **Sections**:
  - Form field labels and placeholders
  - Validation error messages
  - Success/error messages
  - Button labels and help text

#### 4. ProfileEdit Page Component (`frontend/src/pages/profile/ProfileEdit.tsx`)
- **Location**: `frontend/src/pages/profile/ProfileEdit.tsx`
- **Purpose**: Main edit profile page component with form handling
- **Dependencies**:
  - `useTranslation` hook for i18n support
  - React Hook Form with Zod validation
  - Shadcn/UI form components (Input, Select, Textarea, Button, Card)
  - Tailwind CSS for responsive layout
  - Custom `apiProfile` service for API calls

#### 5. Form Schema and Validation (`frontend/src/lib/validation/profileValidation.ts`)
- **Location**: `frontend/src/lib/validation/profileValidation.ts`
- **Purpose**: Zod validation schemas specific to profile forms
- **Schemas**:
  - `profileUpdateSchema`: Main validation schema for profile updates
  - `nicknameSchema`: Specific validation for nickname field
  - `birthDateSchema`: Date validation with business rules
  - `countrySchema`: Country validation against allowed list

#### 6. Route Configuration
- **File**: `frontend/src/App.tsx`
- **Route**: `/profile/edit`
- **Protection**: `ProtectedRoute` wrapper required

### API Integration

#### 1. Profile API Service Implementation (`frontend/src/lib/apiProfile.ts`)
- **Base Functions**:
  ```typescript
  export async function getProfile(): Promise<UserProfile> {
    const response = await authFetch('/profile');
    return response.json();
  }

  export async function updateProfile(updates: ProfileUpdateInput): Promise<UserProfile> {
    const response = await authFetch('/profile', {
      method: 'PUT',
      body: JSON.stringify(updates)
    });
    return response.json();
  }
  ```

#### 2. Real-time Validation Functions
- **Nickname Availability**: GraphQL query with debouncing
  ```typescript
  export async function checkNicknameAvailability(nickname: string): Promise<boolean> {
    return await isNicknameAvailable(nickname);
  }
  ```
- **Debounced Validation**: 500ms debounce for nickname checks
- **Field Validation**: Individual field validation functions

#### 3. Data Transformation
- **Country List**: Transform country codes to display names
- **Form Data Mapping**: Convert between API format and form format
- **Error Normalization**: Standardize API error responses

### UI/UX Design

#### 1. Form Layout
- **Responsive Grid**: Single column on mobile, 2-column on desktop
- **Field Groups**:
  - Basic Information: fullName, nickname, birthDate
  - Location & Identity: country, language, gender, pronouns
  - About: bio, tags
- **Form Actions**: Save, Cancel, Reset buttons

#### 2. Accessibility Features
- **Labels**: Proper `label` elements for all form fields
- **Roles**: Appropriate ARIA roles for form elements
- **Keyboard Navigation**: Full keyboard accessibility
- **Screen Reader**: Descriptive error messages and field labels
- **Focus Management**: Proper focus flow and error focus

#### 3. Loading and Error States
- **Loading Skeleton**: Show loading state while fetching profile data
- **Form Submission**: Disable form during update with loading indicator
- **Error Display**: Show field-level and form-level errors
- **Success Feedback**: Toast notification on successful update

### Backend Integration

#### 1. DynamoDB Operations
- **Table**: `gg_core` (single-table design)
- **Primary Key**: `USER#{userId}` / `PROFILE#{userId}`
- **GSI Updates**: Update GSI2PK/GSI2SK for nickname changes
- **Validation**: Server-side validation in user-service FastAPI endpoint

#### 2. Nickname Uniqueness
- **Lock Pattern**: Use `NICK#{nickname}` uniqueness locks
- **Transaction**: Atomic update of profile and nickname locks
- **Conflict Resolution**: Rollback on nickname conflicts

### Testing Strategy

#### 1. Unit Tests
- **Component Tests**: Form rendering, validation, submission
  - Location: `frontend/src/pages/profile/__tests__/ProfileEdit.test.tsx`
- **API Service Tests**: Profile API functions and error handling
  - Location: `frontend/src/lib/__tests__/apiProfile.test.ts`
- **Model Tests**: TypeScript interfaces and data transformation
  - Location: `frontend/src/models/__tests__/profile.test.ts`
- **Validation Tests**: Zod schemas and business logic validation
  - Location: `frontend/src/lib/validation/__tests__/profileValidation.test.ts`
- **Translation Tests**: i18n keys and language switching
  - Location: `frontend/src/i18n/__tests__/profile.test.ts`

#### 2. Integration Tests
- **E2E Flow**: Login → Navigate to edit profile → Update fields → Verify changes
- **API Integration**: Mock API calls, test error scenarios
- **Form Validation**: Test all validation rules and error messages
- **Automation**: Selenium-based test in `tests/integration/editProfileTest.js`
- **PowerShell Runner**: `scripts/run-edit-profile-test.ps1`

### Infrastructure

#### 1. Terraform Configuration
- **Lambda Function**: User-service container deployment
- **API Gateway**: REST API endpoints
- **DynamoDB**: Core table with GSI configuration
- **IAM Roles**: Least-privilege permissions for user-service
- **SSM Parameters**: Environment configuration

#### 2. Environment Deployment
- **Dev Environment**: Full infrastructure deployment
- **Testing**: Automated deployment verification
- **Monitoring**: CloudWatch logs and X-Ray tracing

### Security Considerations

#### 1. Data Validation
- **Input Sanitization**: Server-side validation in FastAPI
- **Type Safety**: Pydantic models for request/response
- **SQL Injection Prevention**: Parameterized DynamoDB queries

#### 2. Authorization
- **User Isolation**: Verify `userId` matches authenticated user
- **Field Permissions**: All profile fields editable by profile owner
- **Audit Logging**: Structured logs for profile changes

### Performance Optimization

#### 1. Form Optimization
- **Debounced Validation**: Reduce API calls during typing
- **Lazy Loading**: Load profile data on component mount
- **Optimistic Updates**: Immediate UI feedback during submission

#### 2. API Optimization
- **Caching**: Browser caching for static assets
- **Compression**: API Gateway response compression
- **Connection Pooling**: DynamoDB connection optimization

### Translation Implementation

#### 1. Profile Translation Interface (`frontend/src/i18n/profile.ts`)
```typescript
export type Language = 'en' | 'es' | 'fr';

export interface ProfileTranslations {
  title: string;
  subtitle: string;
  basicInfo: {
    title: string;
    fullName: { label: string; placeholder: string };
    nickname: { label: string; placeholder: string; help: string };
    birthDate: { label: string; placeholder: string };
  };
  location: {
    title: string;
    country: { label: string; placeholder: string };
    language: { label: string };
  };
  identity: {
    title: string;
    gender: { label: string; placeholder: string };
    pronouns: { label: string; placeholder: string };
  };
  about: {
    title: string;
    bio: { label: string; placeholder: string; help: string };
    tags: { label: string; placeholder: string; help: string };
  };
  actions: {
    save: string;
    cancel: string;
    reset: string;
  };
  validation: {
    required: string;
    nicknameTaken: string;
    invalidFormat: string;
    tooLong: string;
  };
  messages: {
    saveSuccess: string;
    saveError: string;
    loading: string;
  };
}
```

#### 2. Translation Integration
- **Hook Usage**: `const { t } = useTranslation(); t.profile.title`
- **Form Labels**: All field labels use translation keys
- **Validation Messages**: Error messages from translation files
- **Success/Error Messages**: Toast notifications use translations

## Implementation Phases

### Phase 1: Foundation Setup
1. Create `models/profile.ts` with TypeScript interfaces
2. Create `lib/apiProfile.ts` with API service functions
3. Create `i18n/profile.ts` with translation definitions
4. Create `lib/validation/profileValidation.ts` with Zod schemas
5. Add route configuration in `App.tsx`

### Phase 2: Core Form Component
1. Create `ProfileEdit.tsx` component with basic form structure
2. Implement form fields with proper types and i18n labels
3. Integrate API service for data fetching and updates
4. Add basic form validation and error handling
5. Implement responsive design with Tailwind

### Phase 3: Enhanced UX and Features
1. Add accessibility features (ARIA labels, keyboard navigation)
2. Implement real-time nickname validation with debouncing
3. Add loading states and comprehensive error handling
4. Implement success/error feedback with translations
5. Add form reset and cancel functionality

### Phase 4: Testing and Polish
1. Write unit tests for all new components and services
2. Create integration test automation with Selenium
3. Performance optimization and accessibility testing
4. Code review and documentation updates
5. Deploy to dev environment for testing

## Acceptance Criteria
- [ ] `models/profile.ts` created with proper TypeScript interfaces
- [ ] `lib/apiProfile.ts` created with dedicated API service functions
- [ ] `i18n/profile.ts` created following project translation pattern
- [ ] `lib/validation/profileValidation.ts` created with Zod schemas
- [ ] ProfileEdit component uses i18n translations for all text
- [ ] API integration in separate service file, not in component
- [ ] Form renders all profile fields correctly with i18n labels
- [ ] Zod validation works for all field types with translated messages
- [ ] Nickname uniqueness validation functions with debouncing
- [ ] Form submission updates profile via dedicated API service
- [ ] Responsive design works on mobile and desktop
- [ ] Accessibility standards met (WCAG 2.1 AA)
- [ ] Error states handled gracefully with translated messages
- [ ] Loading states provide good UX with i18n text
- [ ] Unit tests pass with >90% coverage for all new files
- [ ] Integration tests pass in automated environment
- [ ] Backend handles all edge cases and validation
- [ ] Terraform deployment succeeds in dev environment
