# 13.1 CreateTask 403 Error Debugging

## Issue
The `createTask` API call is getting a 403 Forbidden error, while `updateTask` works fine with the same API key.

## Investigation Results

### 1. API Key Configuration ✅
- ✅ `createTask` now has `x-api-key` header (fixed)
- ✅ `updateTask` has `x-api-key` header (working)
- ✅ Both use same authentication pattern

### 2. API Gateway Configuration ✅
- ✅ Both endpoints use `authorization = "CUSTOM"` with lambda authorizer
- ✅ Both endpoints have similar Terraform configuration
- ✅ Neither endpoint has `api_key_required = true` explicitly set

### 3. Backend Validation Checks
The `createTask` endpoint has several validation checks that could cause 403 errors:

```python
# 1. Goal ownership validation
response = table.get_item(
  Key={"PK": f"USER#{user_id}", "SK": f"GOAL#{payload.goalId}"}
)
if not goal_item:
  raise HTTPException(status_code=404, detail="Goal not found")

# 2. Goal status validation  
if goal_item.get("status") != "active":
  raise HTTPException(status_code=400, detail="Cannot add task to inactive goal")

# 3. Goal deadline validation
goal_deadline_str = goal_item.get("deadline")
if not goal_deadline_str:
  raise HTTPException(status_code=400, detail="Goal deadline is missing")

# 4. Task due date validation
if task_due_date > goal_deadline_date:
  raise HTTPException(status_code=400, detail="Task due date cannot exceed goal deadline")
```

### 4. Potential Root Causes
The 403 error might be caused by:

1. **Goal not found** - The goalId doesn't exist or user doesn't own it
2. **Goal not active** - The goal status is not "active"
3. **Missing goal deadline** - The goal doesn't have a deadline set
4. **Task due date exceeds goal deadline** - The task due date is after the goal deadline
5. **Authentication issue** - The user token is invalid or expired

### 5. Debugging Added
Added detailed error logging to `createTask` function:

```typescript
if (!response.ok) {
  const errorBody = await response.json().catch(() => ({}));
  const message = errorBody.detail || response.statusText || 'Failed to create task';
  console.error('CreateTask API Error:', {
    status: response.status,
    statusText: response.statusText,
    errorBody,
    url,
    input
  });
  throw new Error(message);
}
```

## Next Steps

### 1. Test and Check Console
1. **Try creating a task** - Should show detailed error in console
2. **Check error details** - Look for specific validation failure
3. **Verify goal data** - Ensure goal has required fields

### 2. Common Issues to Check
- **Goal status** - Must be "active"
- **Goal deadline** - Must be set and in YYYY-MM-DD format
- **Task due date** - Must be before goal deadline
- **Goal ownership** - User must own the goal

### 3. Expected Error Messages
- `"Goal not found"` - GoalId doesn't exist or user doesn't own it
- `"Cannot add task to inactive goal"` - Goal status is not "active"
- `"Goal deadline is missing"` - Goal doesn't have a deadline
- `"Task due date cannot exceed goal deadline"` - Task due date is after goal deadline

## Files Modified
- `frontend/src/lib/apiTask.ts` - Added detailed error logging to createTask function

## Result
The debugging will help identify the specific validation failure causing the 403 error. Once identified, we can fix the root cause (likely goal data validation issues).
