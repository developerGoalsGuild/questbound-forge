# 13.1 CreateTask IAM Policy Fix

## Issue
The `createTask` API call is getting a 403 Forbidden error with the message:
```json
{
    "Message": "User is not authorized to access this resource because no identity-based policy allows the execute-api:Invoke action"
}
```

## Root Cause
The API Gateway was missing a resource policy that allows public access to invoke the API endpoints. Without this policy, AWS blocks all requests to the API Gateway with an IAM authorization error.

## Solution Applied

### Added Resource Policy to API Gateway
Added a resource policy to the `aws_api_gateway_rest_api` resource to allow public access:

```hcl
resource "aws_api_gateway_rest_api" "rest_api" {
  name        = "goalsguild_api_${var.environment}"
  description = "API Gateway for GoalsGuild services"
  
  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Principal = "*"
        Action = "execute-api:Invoke"
        Resource = "*"
      }
    ]
  })
}
```

### What This Policy Does
- **Effect: "Allow"** - Grants permission
- **Principal: "*"** - Applies to all users (public access)
- **Action: "execute-api:Invoke"** - Allows API Gateway invocation
- **Resource: "*"** - Applies to all API Gateway resources

## Files Modified
- `backend/infra/terraform2/modules/apigateway/api_gateway.tf` - Added resource policy to API Gateway

## Deployment Required

### 1. Deploy the Infrastructure Changes
```bash
# Navigate to the API Gateway stack
cd backend/infra/terraform2/stacks/apigateway

# Deploy the changes
./deploy-apigateway.ps1 -Env dev
```

### 2. Verify the Deployment
After deployment, the API Gateway should allow public access and the `createTask` endpoint should work.

## Security Considerations

### Current Policy
The current policy allows public access to all API Gateway endpoints. This is appropriate for a public API that uses:
- Lambda authorizer for authentication
- API key validation
- Proper input validation

### Future Enhancements
For production, consider more restrictive policies:
```hcl
policy = jsonencode({
  Version = "2012-10-17"
  Statement = [
    {
      Effect = "Allow"
      Principal = "*"
      Action = "execute-api:Invoke"
      Resource = [
        "${aws_api_gateway_rest_api.rest_api.execution_arn}/*/POST/quests/createTask",
        "${aws_api_gateway_rest_api.rest_api.execution_arn}/*/PUT/quests/tasks/*",
        "${aws_api_gateway_rest_api.rest_api.execution_arn}/*/DELETE/quests/tasks/*"
      ]
    }
  ]
})
```

## Testing

### 1. Test CreateTask
1. **Open the application** - Navigate to a goal
2. **Click Create Task** - Open the create task modal
3. **Fill in the form** - Add title, due date, tags, status
4. **Submit the form** - Should create the task successfully
5. **Check console** - Should not see 403 errors

### 2. Test Other Endpoints
- **Update Task** - Should work (was working before)
- **Delete Task** - Should work
- **Create Goal** - Should work
- **Update Goal** - Should work

## Expected Result
- âœ… No more 403 IAM authorization errors
- âœ… CreateTask endpoint works properly
- âœ… All API Gateway endpoints accessible
- âœ… Proper authentication still enforced by lambda authorizer

## Notes
- The lambda authorizer still provides authentication
- API key validation still applies
- This only fixes the IAM policy issue
- The API Gateway now allows public access to invoke endpoints

The createTask functionality should now work properly! ðŸš€
