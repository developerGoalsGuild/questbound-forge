# 13.1 Goal Creation Form - Test Scenarios

## Overview
Comprehensive test scenarios for the Goal Creation Form feature (13.1) covering all phases of implementation including accessibility, validation, error handling, and user experience features.

## Test Environment Setup

### Prerequisites
- Frontend development server running on `http://localhost:8080`
- Backend API available with goal creation endpoints
- Test user credentials configured
- Selenium Grid running (for E2E tests)
- Network simulation tools (for network error testing)

### Test Data
```javascript
const testGoalData = {
  valid: {
    title: "Learn TypeScript",
    description: "Master TypeScript programming language",
    deadline: "2024-12-31",
    category: "learning",
    nlpAnswers: {
      positive: "I will learn TypeScript",
      specific: "Complete 3 TypeScript courses by December",
      evidence: "I will have built 5 TypeScript projects",
      resources: "Online courses, books, practice projects",
      obstacles: "Time management, complex concepts",
      ecology: "Will help with career advancement",
      timeline: "3 months, evenings and weekends",
      firstStep: "Enroll in first TypeScript course"
    }
  },
  invalid: {
    title: "", // Empty title
    deadline: "2023-01-01", // Past date
    nlpAnswers: {
      positive: "x" // Too short
    }
  }
};
```

## Test Categories

### 1. Unit Tests

#### 1.1 Component Rendering Tests
**File**: `frontend/src/components/forms/__tests__/GoalCreationForm.test.tsx`

```typescript
describe('GoalCreationForm Rendering', () => {
  test('renders form with all required fields', () => {
    render(<GoalCreationForm />);
    
    expect(screen.getByTestId('goal-creation-form')).toBeInTheDocument();
    expect(screen.getByLabelText(/goal title/i)).toBeInTheDocument();
    expect(screen.getByLabelText(/description/i)).toBeInTheDocument();
    expect(screen.getByLabelText(/deadline/i)).toBeInTheDocument();
    expect(screen.getByLabelText(/category/i)).toBeInTheDocument();
  });

  test('renders all NLP questions', () => {
    render(<GoalCreationForm />);
    
    const nlpQuestions = [
      'State your goal positively',
      'Make it specific and context-bound',
      'How will you know you achieved it?',
      'What resources do you have/need?',
      'What obstacles might arise?',
      'Is this ecological for you and others?',
      'When, where, with whom will this happen?',
      'What is your immediate first step?'
    ];
    
    nlpQuestions.forEach(question => {
      expect(screen.getByText(question)).toBeInTheDocument();
    });
  });

  test('renders form actions', () => {
    render(<GoalCreationForm />);
    
    expect(screen.getByRole('button', { name: /create goal/i })).toBeInTheDocument();
    expect(screen.getByRole('button', { name: /reset/i })).toBeInTheDocument();
    expect(screen.getByRole('button', { name: /cancel/i })).toBeInTheDocument();
  });
});
```

#### 1.2 Validation Tests
```typescript
describe('Form Validation', () => {
  test('validates required fields', async () => {
    render(<GoalCreationForm />);
    
    const submitButton = screen.getByRole('button', { name: /create goal/i });
    await user.click(submitButton);
    
    expect(screen.getByText(/goal title is required/i)).toBeInTheDocument();
    expect(screen.getByText(/deadline is required/i)).toBeInTheDocument();
  });

  test('validates title length', async () => {
    render(<GoalCreationForm />);
    
    const titleInput = screen.getByLabelText(/goal title/i);
    await user.type(titleInput, 'ab'); // Too short
    
    const submitButton = screen.getByRole('button', { name: /create goal/i });
    await user.click(submitButton);
    
    expect(screen.getByText(/title must be at least 3 characters/i)).toBeInTheDocument();
  });

  test('validates deadline is future date', async () => {
    render(<GoalCreationForm />);
    
    const deadlineInput = screen.getByLabelText(/deadline/i);
    await user.type(deadlineInput, '2023-01-01'); // Past date
    
    const submitButton = screen.getByRole('button', { name: /create goal/i });
    await user.click(submitButton);
    
    expect(screen.getByText(/deadline must be in the future/i)).toBeInTheDocument();
  });

  test('validates NLP answers length', async () => {
    render(<GoalCreationForm />);
    
    const positiveInput = screen.getByLabelText(/state your goal positively/i);
    await user.type(positiveInput, 'x'); // Too short
    
    const submitButton = screen.getByRole('button', { name: /create goal/i });
    await user.click(submitButton);
    
    expect(screen.getByText(/answer must be at least 10 characters/i)).toBeInTheDocument();
  });
});
```

#### 1.3 Accessibility Tests
```typescript
describe('Accessibility', () => {
  test('has proper ARIA labels', () => {
    render(<GoalCreationForm />);
    
    expect(screen.getByRole('form')).toHaveAttribute('aria-label', 'Goal creation form');
    expect(screen.getByLabelText(/goal title/i)).toHaveAttribute('id', 'goal-title');
    expect(screen.getByLabelText(/deadline/i)).toHaveAttribute('id', 'goal-deadline');
  });

  test('supports keyboard navigation', async () => {
    render(<GoalCreationForm />);
    
    const titleInput = screen.getByLabelText(/goal title/i);
    titleInput.focus();
    
    await user.keyboard('{Tab}');
    expect(screen.getByLabelText(/description/i)).toHaveFocus();
    
    await user.keyboard('{Tab}');
    expect(screen.getByLabelText(/deadline/i)).toHaveFocus();
  });

  test('announces validation errors to screen readers', async () => {
    render(<GoalCreationForm />);
    
    const submitButton = screen.getByRole('button', { name: /create goal/i });
    await user.click(submitButton);
    
    const liveRegion = screen.getByRole('status');
    expect(liveRegion).toHaveTextContent(/validation error/i);
  });
});
```

#### 1.4 Loading State Tests
```typescript
describe('Loading States', () => {
  test('shows skeleton loading on initial load', () => {
    render(<GoalCreationForm />);
    
    // Should show skeleton components
    expect(screen.getByTestId('skeleton-form-section')).toBeInTheDocument();
    expect(screen.getByTestId('skeleton-nlp-questions')).toBeInTheDocument();
  });

  test('shows loading state during submission', async () => {
    const mockCreateGoal = vi.fn().mockImplementation(() => 
      new Promise(resolve => setTimeout(resolve, 1000))
    );
    
    vi.mocked(createGoal).mockImplementation(mockCreateGoal);
    
    render(<GoalCreationForm />);
    
    // Fill form
    await user.type(screen.getByLabelText(/goal title/i), 'Test Goal');
    await user.type(screen.getByLabelText(/deadline/i), '2024-12-31');
    
    const submitButton = screen.getByRole('button', { name: /create goal/i });
    await user.click(submitButton);
    
    expect(screen.getByText(/creating/i)).toBeInTheDocument();
    expect(submitButton).toBeDisabled();
  });
});
```

#### 1.5 Error Handling Tests
```typescript
describe('Error Handling', () => {
  test('handles network errors', async () => {
    vi.mocked(createGoal).mockRejectedValue(new Error('Network error'));
    
    render(<GoalCreationForm />);
    
    // Fill and submit form
    await user.type(screen.getByLabelText(/goal title/i), 'Test Goal');
    await user.type(screen.getByLabelText(/deadline/i), '2024-12-31');
    
    const submitButton = screen.getByRole('button', { name: /create goal/i });
    await user.click(submitButton);
    
    expect(screen.getByText(/network error/i)).toBeInTheDocument();
    expect(screen.getByRole('button', { name: /retry/i })).toBeInTheDocument();
  });

  test('handles server validation errors', async () => {
    const serverError = {
      message: 'Validation failed',
      field_errors: {
        title: 'Title already exists',
        deadline: 'Invalid date format'
      }
    };
    
    vi.mocked(createGoal).mockRejectedValue(new Error(JSON.stringify(serverError)));
    
    render(<GoalCreationForm />);
    
    // Fill and submit form
    await user.type(screen.getByLabelText(/goal title/i), 'Test Goal');
    await user.type(screen.getByLabelText(/deadline/i), '2024-12-31');
    
    const submitButton = screen.getByRole('button', { name: /create goal/i });
    await user.click(submitButton);
    
    expect(screen.getByText(/title already exists/i)).toBeInTheDocument();
    expect(screen.getByText(/invalid date format/i)).toBeInTheDocument();
  });
});
```

### 2. Integration Tests

#### 2.1 Form Submission Flow
**File**: `frontend/src/components/forms/__tests__/GoalCreationForm.integration.test.tsx`

```typescript
describe('Goal Creation Integration', () => {
  test('successful goal creation flow', async () => {
    const mockOnSuccess = vi.fn();
    const mockGoalResponse = { id: 'goal-123', title: 'Test Goal' };
    
    vi.mocked(createGoal).mockResolvedValue(mockGoalResponse);
    
    render(<GoalCreationForm onSuccess={mockOnSuccess} />);
    
    // Fill basic information
    await user.type(screen.getByLabelText(/goal title/i), 'Learn TypeScript');
    await user.type(screen.getByLabelText(/description/i), 'Master TypeScript programming');
    await user.type(screen.getByLabelText(/deadline/i), '2024-12-31');
    
    // Select category
    const categorySelect = screen.getByLabelText(/category/i);
    await user.click(categorySelect);
    await user.click(screen.getByText('Learning'));
    
    // Fill NLP answers
    await user.type(screen.getByLabelText(/state your goal positively/i), 'I will learn TypeScript');
    await user.type(screen.getByLabelText(/make it specific/i), 'Complete 3 courses by December');
    // ... fill other NLP answers
    
    // Submit form
    const submitButton = screen.getByRole('button', { name: /create goal/i });
    await user.click(submitButton);
    
    // Verify API call
    expect(createGoal).toHaveBeenCalledWith({
      title: 'Learn TypeScript',
      description: 'Master TypeScript programming',
      deadline: '2024-12-31',
      category: 'learning',
      nlpAnswers: expect.objectContaining({
        positive: 'I will learn TypeScript',
        specific: 'Complete 3 courses by December'
      })
    });
    
    // Verify success callback
    expect(mockOnSuccess).toHaveBeenCalledWith('goal-123');
  });
});
```

#### 2.2 Real-time Validation Integration
```typescript
describe('Real-time Validation Integration', () => {
  test('validates fields as user types', async () => {
    render(<GoalCreationForm />);
    
    const titleInput = screen.getByLabelText(/goal title/i);
    
    // Type invalid input
    await user.type(titleInput, 'ab');
    
    // Wait for debounced validation
    await waitFor(() => {
      expect(screen.getByText(/title must be at least 3 characters/i)).toBeInTheDocument();
    }, { timeout: 1000 });
    
    // Type valid input
    await user.clear(titleInput);
    await user.type(titleInput, 'Valid Title');
    
    // Wait for validation to clear
    await waitFor(() => {
      expect(screen.queryByText(/title must be at least 3 characters/i)).not.toBeInTheDocument();
    }, { timeout: 1000 });
  });
});
```

### 3. End-to-End Tests

#### 3.1 Complete User Journey
**File**: `tests/integration/goalCreationTest.js`

```javascript
/**
 * E2E: Goal Creation Flow
 * Tests the complete user journey from login to goal creation
 */
import { Builder, By, until, Key } from 'selenium-webdriver';

const SELENIUM_GRID_URL = process.env.SELENIUM_GRID_URL || 'http://localhost:4444/wd/hub';
const BASE_URL = process.env.BASE_URL || 'http://localhost:8080';
const TEST_USER_EMAIL = process.env.TEST_USER_EMAIL;
const TEST_USER_PASSWORD = process.env.TEST_USER_PASSWORD;

async function login(driver) {
  await driver.get(`${BASE_URL}/login`);
  const emailInput = await driver.wait(until.elementLocated(By.id('email')), 10000);
  await emailInput.sendKeys(TEST_USER_EMAIL);
  const passwordInput = await driver.findElement(By.id('password'));
  await passwordInput.sendKeys(TEST_USER_PASSWORD);
  const submitButton = await driver.findElement(By.css('button[type="submit"]'));
  await submitButton.click();
  await driver.wait(until.urlContains('/dashboard'), 15000);
}

async function navigateToGoalCreation(driver) {
  // Navigate to goals page
  await driver.get(`${BASE_URL}/goals`);
  await driver.wait(until.elementLocated(By.xpath("//button[contains(., 'Create New Goal')]")), 10000);
  
  // Click create goal button
  const createButton = await driver.findElement(By.xpath("//button[contains(., 'Create New Goal')]"));
  await createButton.click();
  
  // Wait for form to load
  await driver.wait(until.elementLocated(By.css('[data-testid="goal-creation-form"]')), 10000);
}

async function fillGoalForm(driver) {
  // Basic Information
  const titleInput = await driver.wait(until.elementLocated(By.id('goal-title')), 10000);
  await titleInput.sendKeys('Learn TypeScript');
  
  const descriptionInput = await driver.findElement(By.id('goal-description'));
  await descriptionInput.sendKeys('Master TypeScript programming language');
  
  const deadlineInput = await driver.findElement(By.id('goal-deadline'));
  await deadlineInput.sendKeys('2024-12-31');
  
  // Category selection
  const categorySelect = await driver.findElement(By.css('[role="combobox"]'));
  await categorySelect.click();
  const learningOption = await driver.wait(until.elementLocated(By.xpath("//*[contains(text(), 'Learning')]")), 5000);
  await learningOption.click();
  
  // NLP Questions
  const nlpQuestions = [
    { id: 'nlp-positive', answer: 'I will learn TypeScript programming language' },
    { id: 'nlp-specific', answer: 'Complete 3 TypeScript courses by December 2024' },
    { id: 'nlp-evidence', answer: 'I will have built 5 TypeScript projects' },
    { id: 'nlp-resources', answer: 'Online courses, books, practice projects' },
    { id: 'nlp-obstacles', answer: 'Time management, complex concepts' },
    { id: 'nlp-ecology', answer: 'Will help with career advancement' },
    { id: 'nlp-timeline', answer: '3 months, evenings and weekends' },
    { id: 'nlp-firstStep', answer: 'Enroll in first TypeScript course' }
  ];
  
  for (const question of nlpQuestions) {
    const input = await driver.findElement(By.id(question.id));
    await input.sendKeys(question.answer);
  }
}

async function submitGoalForm(driver) {
  const submitButton = await driver.findElement(By.xpath("//button[contains(., 'Create Goal')]"));
  await submitButton.click();
  
  // Wait for success or error
  await driver.wait(until.or(
    until.elementLocated(By.xpath("//*[contains(text(), 'Goal created successfully')]")),
    until.elementLocated(By.xpath("//*[contains(text(), 'Error')]"))
  ), 15000);
}

async function runGoalCreationTest() {
  if (!TEST_USER_EMAIL || !TEST_USER_PASSWORD) {
    console.error('Missing TEST_USER_EMAIL or TEST_USER_PASSWORD');
    process.exit(1);
  }

  const driver = await new Builder()
    .usingServer(SELENIUM_GRID_URL)
    .withCapabilities({
      browserName: 'chrome',
      'goog:chromeOptions': { args: ['--headless=new'] }
    })
    .build();

  try {
    await login(driver);
    await navigateToGoalCreation(driver);
    await fillGoalForm(driver);
    await submitGoalForm(driver);
    console.log('E2E: Goal creation flow passed');
  } catch (error) {
    console.error('E2E: Goal creation flow failed:', error);
    throw error;
  } finally {
    await driver.quit();
  }
}

if (process.argv[1] === new URL(import.meta.url).pathname) {
  runGoalCreationTest();
}
```

#### 3.2 Accessibility E2E Tests
```javascript
/**
 * E2E: Accessibility Testing
 * Tests keyboard navigation, screen reader compatibility, and ARIA attributes
 */
async function testKeyboardNavigation(driver) {
  // Test Tab navigation
  const titleInput = await driver.findElement(By.id('goal-title'));
  await titleInput.sendKeys(Key.TAB);
  
  const descriptionInput = await driver.switchTo().activeElement();
  expect(descriptionInput.getAttribute('id')).toBe('goal-description');
  
  // Test Enter key submission
  await titleInput.sendKeys('Test Goal');
  await descriptionInput.sendKeys('Test Description');
  await driver.findElement(By.id('goal-deadline')).sendKeys('2024-12-31');
  
  const submitButton = await driver.findElement(By.xpath("//button[contains(., 'Create Goal')]"));
  await submitButton.sendKeys(Key.ENTER);
}

async function testScreenReaderCompatibility(driver) {
  // Test ARIA labels
  const form = await driver.findElement(By.css('[data-testid="goal-creation-form"]'));
  expect(await form.getAttribute('aria-label')).toBe('Goal creation form');
  
  // Test field labels
  const titleInput = await driver.findElement(By.id('goal-title'));
  const titleLabel = await driver.findElement(By.css('label[for="goal-title"]'));
  expect(await titleLabel.getText()).toContain('Title');
}
```

### 4. Performance Tests

#### 4.1 Form Performance
```typescript
describe('Form Performance', () => {
  test('form renders within acceptable time', async () => {
    const startTime = performance.now();
    render(<GoalCreationForm />);
    const endTime = performance.now();
    
    expect(endTime - startTime).toBeLessThan(1000); // Should render in under 1 second
  });

  test('validation is debounced properly', async () => {
    render(<GoalCreationForm />);
    
    const titleInput = screen.getByLabelText(/goal title/i);
    const validationSpy = vi.spyOn(console, 'log');
    
    // Type rapidly
    await user.type(titleInput, 'a');
    await user.type(titleInput, 'b');
    await user.type(titleInput, 'c');
    
    // Should not trigger validation for each keystroke
    expect(validationSpy).toHaveBeenCalledTimes(1); // Only once after debounce
  });
});
```

### 5. Network Error Tests

#### 5.1 Network Failure Simulation
```typescript
describe('Network Error Handling', () => {
  test('handles offline state', async () => {
    // Mock offline state
    Object.defineProperty(navigator, 'onLine', {
      writable: true,
      value: false
    });
    
    render(<GoalCreationForm />);
    
    expect(screen.getByText(/no internet connection/i)).toBeInTheDocument();
  });

  test('retries failed requests', async () => {
    const mockCreateGoal = vi.fn()
      .mockRejectedValueOnce(new Error('Network error'))
      .mockResolvedValueOnce({ id: 'goal-123' });
    
    vi.mocked(createGoal).mockImplementation(mockCreateGoal);
    
    render(<GoalCreationForm />);
    
    // Fill and submit form
    await user.type(screen.getByLabelText(/goal title/i), 'Test Goal');
    await user.type(screen.getByLabelText(/deadline/i), '2024-12-31');
    
    const submitButton = screen.getByRole('button', { name: /create goal/i });
    await user.click(submitButton);
    
    // Should show retry button
    expect(screen.getByRole('button', { name: /retry/i })).toBeInTheDocument();
    
    // Click retry
    await user.click(screen.getByRole('button', { name: /retry/i }));
    
    // Should succeed on retry
    await waitFor(() => {
      expect(mockCreateGoal).toHaveBeenCalledTimes(2);
    });
  });
});
```

### 6. Internationalization Tests

#### 6.1 Multi-language Support
```typescript
describe('Internationalization', () => {
  test('renders in English', () => {
    render(<GoalCreationForm />);
    
    expect(screen.getByText(/create new goal/i)).toBeInTheDocument();
    expect(screen.getByText(/basic information/i)).toBeInTheDocument();
  });

  test('renders in Spanish', () => {
    // Mock Spanish translations
    const mockTranslations = {
      goalCreation: {
        title: 'Crear Nuevo Objetivo',
        sections: { basicInfo: 'Información Básica' }
      }
    };
    
    vi.mocked(useTranslation).mockReturnValue({
      t: () => mockTranslations,
      language: 'es'
    });
    
    render(<GoalCreationForm />);
    
    expect(screen.getByText(/crear nuevo objetivo/i)).toBeInTheDocument();
    expect(screen.getByText(/información básica/i)).toBeInTheDocument();
  });
});
```

## Test Execution Commands

### Unit Tests
```bash
# Run all unit tests
npm test -- --testPathPattern="GoalCreationForm"

# Run with coverage
npm test -- --coverage --testPathPattern="GoalCreationForm"

# Run specific test suite
npm test -- --testNamePattern="Form Validation"
```

### Integration Tests
```bash
# Run integration tests
npm test -- --testPathPattern="integration"

# Run E2E tests
npm run test:e2e -- --spec="goalCreationTest.js"
```

### Accessibility Tests
```bash
# Run accessibility tests
npm run test:a11y

# Run with axe-core
npm test -- --testNamePattern="Accessibility"
```

## Test Data Management

### Test Database Setup
```sql
-- Clean test data before each test
DELETE FROM goals WHERE title LIKE 'Test%';
DELETE FROM goals WHERE title LIKE 'E2E%';

-- Insert test user if not exists
INSERT INTO users (id, email, name) 
VALUES ('test-user-123', 'test@example.com', 'Test User')
ON CONFLICT (email) DO NOTHING;
```

### Mock Data
```javascript
const mockGoalResponse = {
  id: 'goal-123',
  title: 'Test Goal',
  description: 'Test Description',
  deadline: '2024-12-31',
  category: 'learning',
  status: 'active',
  createdAt: '2024-01-01T00:00:00Z',
  updatedAt: '2024-01-01T00:00:00Z',
  nlpAnswers: {
    positive: 'I will learn TypeScript',
    specific: 'Complete 3 courses',
    evidence: 'Build 5 projects',
    resources: 'Online courses',
    obstacles: 'Time management',
    ecology: 'Career advancement',
    timeline: '3 months',
    firstStep: 'Enroll in course'
  }
};
```

## Expected Test Results

### Coverage Targets
- **Unit Tests**: >90% code coverage
- **Integration Tests**: >80% coverage of critical paths
- **E2E Tests**: 100% of user journeys
- **Accessibility Tests**: WCAG 2.1 AA compliance

### Performance Targets
- **Form Load Time**: <1 second
- **Validation Response**: <500ms
- **API Response**: <2 seconds
- **Accessibility Score**: >95%

### Success Criteria
- All tests pass consistently
- No accessibility violations
- Performance targets met
- Error handling works correctly
- Multi-language support verified

## Troubleshooting

### Common Issues
1. **Test Timeouts**: Increase timeout values for slow operations
2. **Mock Failures**: Ensure all dependencies are properly mocked
3. **Accessibility Violations**: Check ARIA attributes and keyboard navigation
4. **Network Errors**: Verify error handling and retry mechanisms

### Debug Commands
```bash
# Run tests with debug output
npm test -- --verbose --testPathPattern="GoalCreationForm"

# Run E2E tests with screenshots
npm run test:e2e -- --spec="goalCreationTest.js" --screenshot

# Run accessibility tests with detailed output
npm run test:a11y -- --verbose
```

## Test Maintenance

### Regular Updates
- Update test data monthly
- Review test coverage quarterly
- Update accessibility tests with new WCAG guidelines
- Maintain test documentation

### Test Monitoring
- Monitor test execution time
- Track flaky test patterns
- Monitor accessibility score trends
- Track performance regression

This comprehensive test suite ensures the Goal Creation Form meets all requirements for functionality, accessibility, performance, and user experience.
