## Feature 2.1 — Frontend Quest Models Review

Scope: Review of `frontend/src/models/quest.ts` and its tests against the Feature 22.4 specification (User-created quests) and repo conventions.

### Summary
- Overall, the TypeScript models and Zod schemas are comprehensive and largely align with the spec (fields, validation bounds, defaults, and types). The test suite is thorough and covers happy paths, edge cases, and performance.
- Found a few specification mismatches and minor issues to address for correctness, interoperability, and i18n.

### Strengths
- Interfaces reflect the Quest domain well, including `status`, `difficulty`, `privacy`, `kind`, linking arrays, and quantitative fields.
- Validation uses Zod with clear min/max limits and sensible defaults per spec (`rewardXp`, `deadline ≥ now + 1h`, `tags` constraints, etc.).
- Quantitative quests enforce presence of `targetCount`, `countScope`, `startAt`, and `periodSeconds` when `kind === 'quantitative'`.
- Tests are extensive and readable, covering schemas, helper functions, and some performance checks.

### Issues and Recommendations

1) Data contract mismatch: `version` required in `Quest`
- Issue: `Quest` interface declares `version: number` as required, but the GraphQL `myQuests` fields in the plan do not include `version`. REST responses may include `version`, GraphQL likely does not.
- Impact: GraphQL reads may fail type-checking if `version` is absent.
- Fix: Make `version` optional or split models: `Quest` (GraphQL read shape) and `QuestRecord` (REST/DB full shape). Prefer keeping `Quest` aligned to GraphQL and introducing a separate interface for REST.

2) Overly strict ID validation for linked IDs
- Issue: `linkedGoalIds`, `linkedTaskIds`, `dependsOnQuestIds` enforce `z.string().uuid()`. Spec allows ULID/UUID for `id`; linked entities may not be UUID specifically.
- Impact: Valid ULIDs or non-UUID identifiers would be rejected on the client.
- Fix: Relax to allow ULID or UUID. Example: a regex that allows UUID v4 OR ULID, or simply `z.string().min(1)` with server-side validation as source of truth.

3) `startAt` validation message vs logic
- Issue: Error message says "Start time must be in the future" while schema only enforces positive integer, not future relative to now.
- Impact: Inconsistent UX and acceptance of past `startAt` timestamps.
- Fix: Add refine to ensure `startAt > Date.now()` (similar to `deadline` future check), possibly allowing small clock skew.

4) i18n concerns in display helpers
- Issue: `formatQuestStatus`, `formatQuestDifficulty`, and `formatQuestDeadline` return hardcoded English strings.
- Impact: Violates repo i18n rule that all UI text must be translatable.
- Fix: Move display mapping to i18n layer or accept a translator-map param. E.g., return keys (`quest.status.draft`) or require callers to pass translated labels.

5) Category list source of truth
- Observation: Category enum includes 12 categories (Health, Work, Personal, Learning, Fitness, Creative, Financial, Social, Spiritual, Hobby, Travel, Other). The spec examples list a subset; it also states validation must be against a predefined list.
- Recommendation: Confirm backend’s canonical list. If the backend list differs, align the frontend `QUEST_CATEGORIES` with the backend or fetch from a config endpoint.

6) Error message coupling in tests
- Observation: Some tests assert exact Zod error messages (e.g., category invalid option message).
- Risk: Tight coupling to Zod internals may cause brittle tests if library messages change.
- Recommendation: Prefer asserting that parsing throws, or match on a stable substring you control.

### Concrete Fixes (Proposed)
- Make `version` optional on `Quest` or split into GraphQL vs REST interfaces.
- Update linked IDs validation to accept ULID/UUID (or relax to non-empty strings) and defer strict validation to server.
- Enforce `startAt > Date.now()` with a small grace window (e.g., 1 minute) to account for clock skew.
- Replace hardcoded display strings with i18n keys/parameters; move formatting to a view layer helper that consumes translations.
- Confirm and centralize category source (backend → frontend), or add an integration test to prevent drift.
- Loosen tests that depend on Zod’s exact message strings.

### Notable Code References

Version required in `Quest` interface:
```90:110:frontend/src/models/quest.ts
  deadline?: number;
  createdAt: number;
  updatedAt: number;
  version: number;

  // Quest type and configuration
  kind: QuestKind;

  // Linked Quest fields
  linkedGoalIds?: string[];
  linkedTaskIds?: string[];
  dependsOnQuestIds?: string[];
```

Linked IDs enforce UUID only:
```270:279:frontend/src/models/quest.ts
  // Linked Quest fields
  linkedGoalIds: z.array(z.string().uuid('Invalid goal ID')).optional(),
  linkedTaskIds: z.array(z.string().uuid('Invalid task ID')).optional(),
  dependsOnQuestIds: z.array(z.string().uuid('Invalid quest ID')).optional(),
```

`startAt` message vs logic (no future check):
```279:285:frontend/src/models/quest.ts
  // Quantitative Quest fields
  targetCount: z.number().int().positive('Target count must be greater than 0').optional(),
  countScope: QuestCountScopeSchema.optional(),
  startAt: z.number().int().positive('Start time must be in the future').optional(),
  periodSeconds: z.number().int().positive('Period must be greater than 0 seconds').optional(),
```

Hardcoded display helpers (needs i18n):
```411:421:frontend/src/models/quest.ts
const formatQuestStatus = (status: QuestStatus): string => {
  const statusMap: Record<QuestStatus, string> = {
    draft: 'Draft',
    active: 'Active',
    completed: 'Completed',
    cancelled: 'Cancelled',
    failed: 'Failed'
  };
  return statusMap[status] || status;
};
```

### Conclusion
The implementation is close to spec-compliant and well-tested. Addressing the listed issues will ensure stronger contract alignment (GraphQL vs REST), better UX consistency (time validations), and adherence to localization standards. After these fixes, Feature 2.1 models and validation would be production-ready.


